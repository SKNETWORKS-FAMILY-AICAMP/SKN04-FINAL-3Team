<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
    <!-- í´ë¦­ ì‹œ ì´ë™: id="profileLink" -->
    <div class="language-section">
        <span style="font-size: 40px;">ğŸŒ</span>
        <label id="label_language" for="language">
        <select id="language" onchange="updateLanguage(this.value)">
            <option value="US" {% if settings.country_id == 'US' %}selected{% endif %}>English</option> 
            <option value="KR" {% if settings.country_id == 'KR' %}selected{% endif %}>í•œêµ­ì–´</option> 
            <option value="JP" {% if settings.country_id == 'JP' %}selected{% endif %}>æ—¥æœ¬èª</option> 
            <option value="CN" {% if settings.country_id == 'CN' %}selected{% endif %}>ç®€ä½“å­—</option> 
        </select>
    </div>
    <div class="profile-section">
        <img class="nav-icon" id="nav-icon"
                data-light="{% static 'images/nav/nav_profile_light.png' %}" 
                data-dark="{% static 'images/nav/nav_profile_dark.png' %}" 
                src="{% static 'images/nav/nav_profile_light.png' %}" 
                style="width: 35px; height: 35px; cursor: pointer;">
        <span id="profileLink">
            {% if user.is_authenticated %}
                {{ user.username }}
            {% else %}
                {% if settings.country_id == "US" %}Sign In
                {% elif settings.country_id == "KR" %}ë¡œê·¸ì¸
                {% elif settings.country_id == "JP" %}ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                {% elif settings.country_id == "CN" %}ç™»å…¥
                {% else %}Sign In{% endif %}
            {% endif %}
        </span>

        <!-- íŒì—…ì°½ -->
        {% if user.is_authenticated %}
        <div id="profilePopup" class="popup hidden">
            <ul>
                <li>
                    <a href="/app/chatting/">                        
                        {% if settings.country_id == "US" %}Chattings
                        {% elif settings.country_id == "KR" %}ì±„íŒ…
                        {% elif settings.country_id == "JP" %}ãŠã—ã‚ƒã¹ã‚Š
                        {% elif settings.country_id == "CN" %}èŠå¤©{% endif %}
                    </a>
                </li>
                <li>
                    <a href="/app/favorites/">                        
                        {% if settings.country_id == "US" %}Bookmarks
                        {% elif settings.country_id == "KR" %}ì¦ê²¨ì°¾ê¸°
                        {% elif settings.country_id == "JP" %}ãŠæ°—ã«å…¥ã‚Š
                        {% elif settings.country_id == "CN" %}æ”¶è—å¤¹{% endif %}
                    </a>
                </li>
                <li>
                    <a href="/app/settings/">                        
                        {% if settings.country_id == "US" %}Settings
                        {% elif settings.country_id == "KR" %}ì„¤ì •
                        {% elif settings.country_id == "JP" %}è¨­å®š
                        {% elif settings.country_id == "CN" %}è®¾ç½®{% endif %}
                    </a>
                </li>
                <li>
                    <a href="/app/profile/">                        
                        {% if settings.country_id == "US" %}Profile
                        {% elif settings.country_id == "KR" %}ë‚´ í”„ë¡œí•„
                        {% elif settings.country_id == "JP" %}ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                        {% elif settings.country_id == "CN" %}è½®å»“{% endif %}
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- íƒ€ì´í‹€ -->
        <div class="title">SeouLOGUE</div>

        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div class="input-wrapper">
            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ë€ -->
            <textarea 
                class="input-box" 
                placeholder="ì¼ì •ì„ ë§Œë“¤ê±°ë‚˜ ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ ë³´ì„¸ìš”"
                rows="2"
                maxlength="2000"
            ></textarea>
            <!-- ê²€ì€ìƒ‰ ë²„íŠ¼ -->
            <button class="send-button" onclick="goToEnterPage()">ğŸ”</button>
        </div>
    </div>

    <!-- (A) Djangoì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ JS ë³€ìˆ˜ë¡œ ë„˜ê¹€ -->
    <script>
        // user.is_authenticatedëŠ” True ë˜ëŠ” Falseë¥¼ íŒŒì´ì¬ ë¶€ìš¸í˜•ìœ¼ë¡œ ê°€ì§€ë¯€ë¡œ,
        // í…œí”Œë¦¿ í•„í„° yesno:"true,false"ë¥¼ ì‚¬ìš©í•´ JSì—ì„œ ì“¸ ìˆ˜ ìˆë„ë¡ ë³€í™˜
        const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};
        const name = `{{ user.username }}`;

        // (B) "My Profile" í´ë¦­ ì‹œ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const popup = document.getElementById('profilePopup');
            const navicon = document.getElementById('nav-icon');
            const profileLink = document.getElementById('profileLink');

            if (navicon) {
                navicon.addEventListener('click', function(e) {
                    if (isLoggedIn) {
                        // ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆë‹¤ë©´ íŒì—…ì°½ ì—´ê¸°
                        e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                        popup.classList.toggle('hidden');                        
                        // window.location.href = "/app/profile/";
                    } else {
                        // ì•ˆ ë˜ì–´ ìˆë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = "/login/";
                    }
                });
            }
            if (profileLink) {
                profileLink.addEventListener('click', function(e) {
                    if (isLoggedIn) {
                        // ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆë‹¤ë©´ íŒì—…ì°½ ì—´ê¸°
                        e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                        popup.classList.toggle('hidden');                        
                        // window.location.href = "/app/profile/";
                    } else {
                        // ì•ˆ ë˜ì–´ ìˆë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = "/login/";
                    }
                });

                // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                document.addEventListener('click', function (e) {
                    if (popup) {
                        if (!popup.classList.contains('hidden')) {
                            popup.classList.add('hidden');
                        }
                    }                    
                });

                if (popup) {
                    // íŒì—… ë‚´ë¶€ í´ë¦­ ì‹œ ë‹«íˆì§€ ì•ŠìŒ
                    popup.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }                
            }
        });

        async function goToEnterPage() {
            const inputBox = document.querySelector('.input-box');
            const userInput = inputBox.value.trim();

            if (userInput === "") {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            localStorage.setItem("chatMessage", userInput);

            if (isLoggedIn) {
                // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì¼ ê²½ìš° chat_id ê°€ì ¸ì˜¤ê¸°
                try {
                    const response = await fetch("/app/partials/planner/get_or_create_chat_id/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success && data.chat_id) {
                        // chat_idë¥¼ URLì— í¬í•¨í•˜ì—¬ ì´ë™
                        window.location.href = `/app/planner/?chat_id=${encodeURIComponent(data.chat_id)}`;
                    } else {
                        console.error("Failed to get chat_id:", data.error || "Unknown error");
                        alert("chat_idë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    console.error("Error fetching chat_id:", error);
                    alert("chat_idë¥¼ ê°€ì ¸ì˜¤ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì¼ ê²½ìš°
                window.location.href = `/app/planner/?chatMessage=${encodeURIComponent(userInput)}`;
            }
        }

        // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì • ë° ë²„íŠ¼ ìœ„ì¹˜ ìœ ì§€
        document.querySelector('.input-box').addEventListener('input', function () {
            this.style.height = "auto";
            const scrollHeight = this.scrollHeight;
            const maxHeight = 300; // 6ì¤„ ë†’ì´ ì œí•œ
            this.style.height = `${Math.min(scrollHeight, maxHeight)}px`;

            if (scrollHeight > maxHeight) {
                this.style.overflowY = "scroll";
            } else {
                this.style.overflowY = "hidden";
            }
        });

        // Enter ë° Shift+Enter ì²˜ë¦¬
        document.querySelector('.input-box').addEventListener('keydown', function (e) {
            if (e.key === "Enter" && e.shiftKey) {
                e.preventDefault();
                const cursorPosition = this.selectionStart;
                this.value = this.value.slice(0, cursorPosition) + "\n" + this.value.slice(cursorPosition);
            } else if (e.key === "Enter") {
                e.preventDefault();
                document.querySelector('.send-button').click();
            }
        });

        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            return csrfToken;
        }

        function updateLanguage(selectedCountryId) {
            const profilePopups = document.querySelectorAll("#profilePopup li a");
            const profileLink = document.querySelector("#profileLink");

            const translations_for_sign_in = {
                US: "Sign In",
                KR: "ë¡œê·¸ì¸",
                JP: "ã‚µã‚¤ãƒ³ã‚¤ãƒ³",
                CN: "ç™»å…¥",
            }

            const translations_for_popups = [
                {
                    US: "Chattings",
                    KR: "ì±„íŒ…",
                    JP: "ãŠã—ã‚ƒã¹ã‚Š",
                    CN: "èŠå¤©",
                },
                {
                    US: "Bookmarks",
                    KR: "ì¦ê²¨ì°¾ê¸°",
                    JP: "ãŠæ°—ã«å…¥ã‚Š",
                    CN: "æ”¶è—å¤¹",
                },
                {
                    US: "Settings",
                    KR: "ì„¤ì •",
                    JP: "è¨­å®š",
                    CN: "è®¾ç½®",
                },
                {
                    US: "Profile",
                    KR: "ë‚´ í”„ë¡œí•„",
                    JP: "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«",
                    CN: "è½®å»“",
                },
            ];

            // ìƒˆë¡œ ì„ íƒëœ ì–¸ì–´ì— ë”°ë¥¸ í…ìŠ¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸
            if (name) {
                profileLink.textContent = name;
            }
            else {
                profileLink.textContent = translations_for_sign_in[selectedCountryId];
            }
            profilePopups.forEach((popup, index) => {
                popup.textContent = translations_for_popups[index][selectedCountryId];
            });
        }
    </script>
</body>
</html>

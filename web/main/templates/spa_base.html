<!-- spa_base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA Example</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body data-theme="{% if settings.is_white_theme %}light{% else %}dark{% endif %}">
    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="nav-btn" id="home-btn">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_home_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_home_dark.png' %}" 
                     src="{% static 'images/nav/nav_home_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Home
            </button>
            <button class="nav-btn" data-url="/app/planner/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_planner_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_planner_dark.png' %}" 
                     src="{% static 'images/nav/nav_planner_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Planner
            </button>
            <button class="nav-btn" data-url="/app/chatting/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_chattings_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_chattings_dark.png' %}" 
                     src="{% static 'images/nav/nav_chattings_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Chatting
            </button>
            <button class="nav-btn" data-url="/app/favorites/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_favorites_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_favorites_dark.png' %}" 
                     src="{% static 'images/nav/nav_favorites_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Bookmarks
            </button>
            <button class="nav-btn" data-url="/app/settings/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_settings_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_settings_dark.png' %}" 
                     src="{% static 'images/nav/nav_settings_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Settings
            </button>
            <button class="nav-btn" data-url="/app/profile/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_profile_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_profile_dark.png' %}" 
                     src="{% static 'images/nav/nav_profile_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Profile
            </button>
        </div>

        <!-- ë™ì  ì½˜í…ì¸  ì˜ì—­ -->
        <div id="content1">            
            <!-- AJAXë¡œ ë¶ˆëŸ¬ì˜¨ partial HTMLì´ ì—¬ê¸° ë“¤ì–´ê° -->
        </div>
        <!-- ì§€ë„ ì˜ì—­ -->
        <div id="map-container">
            <div id="map"></div>
            <div id="map-panel">
                <div id="drag-handle"></div> <!-- ë“œë˜ê·¸ í•¸ë“¤ ì¶”ê°€ -->
                <div id="button-panel">
                    <strong id="panel-title"></strong>
                    <div class="button-group">
                        <button id="removeContentBtn" onclick="removeContent()">ğŸ—‘ï¸</button>
                        <button id="getBookmarkListBtn" onclick="getBookmarkList()">â˜†</button>
                        <button id="toggleUIBtn" onclick="toggleMapPanel()">â®Ÿ</button>
                    </div>
                </div> 
                <div class="map-panel-content">
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆë¡œìš´ ì• ë‹ˆë©”ì´ì…˜ìš© DIV -->
    <div id="bookmarklist-div">
        <div style="display: flex; justify-content: flex-end; align-items: flex-end;">
            <button id="closeBookmarkListBtn" onclick="document.querySelector('#bookmarklist-div').classList.remove('active');">âˆ¨</button>
        </div>
        <div class="bookmarklist-panel">
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="text-align: center; margin: 0; margin-bottom: 10px;">Edit this title</h2>
                <h3 style="display: none;"></h3>
                <input id="change-title" type="text" style="display: none; margin: 0 auto; margin-bottom: 10px;" maxlength="20">
                <h6 style="text-align: center; margin: 0;">(Double click the title to edit)</h6>
            </div>
            <ul>

            </ul>
        </div>
    </div>

    <!-- íŒì—… ì°½ -->
    <div id="popup" class="popup hidden">
        <div class="popup-content">
            <h3>Are you sure you want to delete your account?</h3>
            <div class="popup-buttons">
                <button id="confirm-delete" class="popup-button">Yes, Delete</button>
                <button id="cancel-delete" class="popup-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function () {
            // localStorageì˜ íŠ¹ì • í‚¤ ì‚­ì œ
            // localStorage.removeItem('chatMessage');

            // ë˜ëŠ” ëª¨ë“  ë°ì´í„° ì‚­ì œ
            // localStorage.clear();

            // console.log("LocalStorage cleared or specific key removed.");
        };

        const ncpClientId = "{{ ncp_client_id|default:'' }}";
        const ncpClientSecret = "{{ ncp_client_secret|default:'' }}";
        let isMapInitialized = false;
        let map = null;
        let lastLoadedPath = null;
        let globalMarkerData = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
        let isPlaceInputOpen = false;
        let isScheduleInputOpen = false;
        const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};

        // ---------------------------
        // (1) ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        // ---------------------------
        function initializeMap(markerData) {
            if (isMapInitialized) return;

            const mapScript = document.createElement('script');
            mapScript.src = `https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${ncpClientId}`;
            mapScript.onload = function () {
                map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5296, 126.9644), // ìš©ì‚°ì—­ ì¢Œí‘œ
                    zoom: 13,
                });
                isMapInitialized = true;

                // ë§ˆì»¤ ì¶”ê°€
                if (markerData) {
                    markerData.forEach(data => {
                        const marker = new naver.maps.Marker({
                            position: data.position,
                            map: map,
                            title: data.title,
                            icon: {
                                url: data.icon, // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì´ë¯¸ì§€ URL
                                size: new naver.maps.Size(36, 36), // ë§ˆì»¤ í¬ê¸°
                                origin: new naver.maps.Point(0, 0),
                                anchor: new naver.maps.Point(18, 36), // ë§ˆì»¤ ìœ„ì¹˜ ì¡°ì •
                            },
                        });

                        // ì •ë³´ì°½ ìƒì„±
                        // var infoWindow = new naver.maps.InfoWindow({
                        //     content: `<div style="width:200px;text-align:center;padding:10px;">
                        //                 <h4>ê°€ë§¹ì  ì •ë³´</h4>
                        //                 <p>ì—¬ê¸°ì— ê°€ë§¹ì  ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
                        //             </div>`
                        // });

                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒ ì‚¬í•­)
                        naver.maps.Event.addListener(marker, 'click', function () {
                            alert(`${data.title}ì…ë‹ˆë‹¤!`);
                            // infoWindow.open(map, marker); // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ ì—´ê¸°
                        });
                    });

                    // ì„  ì—°ê²°
                    for (let i = 0; i < markerData.length - 1; i++) {
                        const polyline = new naver.maps.Polyline({
                            map: map,
                            path: [markerData[i].position, markerData[i + 1].position], // ì¸ì ‘í•œ ë§ˆì»¤ ì—°ê²°
                            strokeColor: '#000000', // ì„  ìƒ‰ìƒ
                            strokeWeight: 0, // ì„  ë‘ê»˜
                            strokeStyle: 'solid', // ì„  ìŠ¤íƒ€ì¼ (solid, dashed, dotted ë“±)
                        });
                    }
                }
            };
            mapScript.onerror = function () {
                console.error("Failed to load Naver Map script.");
            };

            document.head.appendChild(mapScript);
        }

        // ---------------------------
        // (2) /app/* -> /app/partials/* ì¹˜í™˜ í•¨ìˆ˜
        // ---------------------------
        function toPartialUrl(spaPath) {
            // ì˜ˆ: /app/planner/ -> /app/partials/planner/
            return spaPath.replace(/^\/app/, '/app/partials');
        }

        // í˜„ì¬ í™œì„±í™”ëœ nav-btn í‘œì‹œ í•¨ìˆ˜
        function highlightActiveLink(spaPath) {
            console.log("highlightActiveLink");
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const url = btn.getAttribute('data-url');
                if (!url) return;  // home-btnì´ data-urlì´ ì—†ìœ¼ë¯€ë¡œ ê±´ë„ˆëœ€

                if (url === spaPath) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function loadContent(spaPath) {
            if (lastLoadedPath === spaPath) {
                console.log("ì¤‘ë³µëœ ê²½ë¡œë¡œ ë¡œë“œ ì¤‘ë‹¨:", spaPath, ",lastPath:", lastLoadedPath);
                return;
            }

            lastLoadedPath = spaPath;
            const partialUrl = toPartialUrl(spaPath);
            // console.log("Loading content for path:", partialUrl);

            fetch(partialUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    document.getElementById('content1').innerHTML = html;

                    // spaContentLoaded ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                    document.dispatchEvent(new Event("spaContentLoaded"));
                })
                .catch(error => console.error('Error loading content:', error));
        }

        function updateIconsBasedOnTheme() {
            const isLightTheme = document.body.getAttribute("data-theme") === "light";
            
            const navIcons = document.querySelectorAll(".nav-icon");
            navIcons.forEach(icon => {
                const newSrc = isLightTheme ? icon.getAttribute("data-light") : icon.getAttribute("data-dark");
                icon.setAttribute("src", newSrc);
            });

            const editIcon = document.querySelector(".edit-icon");
            if (editIcon) {
                const newEditSrc = isLightTheme ? editIcon.getAttribute("data-light") : editIcon.getAttribute("data-dark");
                editIcon.setAttribute("src", newEditSrc);
            }

            const deletePlaceBtns = document.querySelectorAll("#deletePlaceBtn");
            deletePlaceBtns.forEach(button => {
                button.src = isLightTheme ? "/static/images/delete_light.png" : "/static/images/delete_dark.png";
            });
        }

        document.addEventListener("DOMContentLoaded", function () {            
            // ì§€ë„ ì´ˆê¸°í™”
            initializeMap();
            updateIconsBasedOnTheme();

            let currentPath = window.location.pathname;

            // /app/ ë§Œ ì…ë ¥ë˜ì—ˆë‹¤ë©´ ë””í´íŠ¸: /app/planner/ ë¡œ ê°€ì •
            if (currentPath === '/app/') {
                currentPath = '/app/planner/';
                history.replaceState(null, '', currentPath);
            }
            loadContent(currentPath);

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const spaPath = this.getAttribute('data-url'); // ì´ë™í•˜ë ¤ëŠ” URL

                    if (!spaPath) return; // URLì´ ì—†ëŠ” ê²½ìš° ë¬´ì‹œ
                    
                    if (isLoggedIn === false) {
                        // ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ê²½ìš° alert ì°½ ë„ìš°ê¸°
                        const confirmLogin = confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í™”ë©´ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                        if (confirmLogin) {
                            // í™•ì¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                            const currentPath = window.location.pathname; // í˜„ì¬ í˜ì´ì§€ ê²½ë¡œ
                            window.location.href = `/login/?next=${encodeURIComponent(spaPath)}`;
                        }
                        // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì•„ë¬´ ì¼ë„ í•˜ì§€ ì•ŠìŒ
                    } else {
                        // ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™
                        history.pushState(null, '', spaPath);
                        loadContent(spaPath); // ë„¤ë¹„ê²Œì´ì…˜ ë°”ì˜ í˜ì´ì§€ ë¡œë”©
                    }
                });
            });

            // Home ë²„íŠ¼ ì²˜ë¦¬
            const homeButton = document.getElementById('home-btn');
            if (homeButton) {
                document.getElementById('home-btn').addEventListener('click', function () {
                    window.location.href = '/';
                });
            }            

            // íŒì—… ì°½ ê¸°ëŠ¥
            document.getElementById('cancel-delete').addEventListener('click', closePopup);
            document.getElementById('confirm-delete').addEventListener('click', function () {
                alert('Account deleted!');
                closePopup();
            });

            // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
            window.addEventListener('popstate', function () {
                loadContent(window.location.pathname);
            });   
            
            const mapPanel = document.getElementById("map-panel");
            const dragHandle = document.getElementById("drag-handle");

            let isDragging = false; // ë“œë˜ê·¸ ìƒíƒœ
            let startY = 0; // ë§ˆìš°ìŠ¤ ì‹œì‘ Y ì¢Œí‘œ
            let startHeight = 0; // mapPanel ì‹œì‘ ë†’ì´

            // ë“œë˜ê·¸ ì‹œì‘
            dragHandle.addEventListener("mousedown", function (e) {
                isDragging = true;
                startY = e.clientY; // ë§ˆìš°ìŠ¤ ì‹œì‘ ìœ„ì¹˜ ì €ì¥
                startHeight = mapPanel.offsetHeight; // mapPanelì˜ ì‹œì‘ ë†’ì´ ì €ì¥

                document.body.style.userSelect = "none"; // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
            });

            // ë“œë˜ê·¸ ì§„í–‰
            document.addEventListener("mousemove", function (e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY; // ë§ˆìš°ìŠ¤ ì´ë™ ê±°ë¦¬
                const newHeight = startHeight - deltaY; // ìƒˆë¡œìš´ íŒ¨ë„ ë†’ì´ ê³„ì‚°
                
                const maxHeight = window.innerHeight * 9 / 10; // í™”ë©´ ì „ì²´ ë†’ì´ì˜ 90%
                const minHeight = 45; // ìµœì†Œ ë†’ì´ ì œí•œ
                
                if (newHeight >= minHeight && newHeight <= maxHeight) {
                    mapPanel.style.height = `${newHeight}px`; // mapPanel ë†’ì´ ì—…ë°ì´íŠ¸

                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    const toggleUIBtn = document.getElementById("toggleUIBtn");
                    toggleUIBtn.textContent = newHeight > minHeight ? "â®Ÿ" : "â®";

                    // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì¡°ì •
                    const buttonContainer = document.getElementById("day-button-container");
                    if (buttonContainer) {
                        const mapPanelTop = mapPanel.getBoundingClientRect().top;
                        buttonContainer.style.top = `${mapPanelTop - buttonContainer.offsetHeight - 15}px`;
                    }
                }
                else if (newHeight < minHeight) {
                    mapPanel.style.height = `45px`;

                    const toggleUIBtn = document.getElementById("toggleUIBtn");
                    toggleUIBtn.textContent = "â®";
                }
            });

            // ë“œë˜ê·¸ ì¢…ë£Œ
            document.addEventListener("mouseup", function () {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = ""; // í…ìŠ¤íŠ¸ ì„ íƒ ë³µêµ¬
                }
            });        
        });
        
        function getCSRFToken() {
            const cookies = document.cookie.split("; ");
            for (let cookie of cookies) {
                if (cookie.startsWith("csrftoken=")) {
                    return cookie.split("=")[1];
                }
            }
            return null;
        }
        
        function showPopup() {
            document.getElementById('popup').classList.remove('hidden');
        }
        
        function closePopup() {
            document.getElementById('popup').classList.add('hidden');
        }

        document.addEventListener("spaContentLoaded", async function () {
            const content1 = document.querySelector('.panel');
            const map = document.getElementById("map");
            const toggleButton = document.getElementById("toggleButton");
            const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
            const chatMessages = document.getElementById("chat-messages");
            let isLoading = false; // ë¡œë”© ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
            let activeAbortController = null; // í˜„ì¬ í™œì„±í™”ëœ AbortController
            let isChatHidden = false;
            let isScrollPaused = false; // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì ì‹œ ë©ˆì¶¤ í”Œë˜ê·¸

            function scrollHandler() {
                if (isScrollPaused) return; // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë©ˆì¶˜ ìƒíƒœë¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ

                if (!isChatHidden) {
                    const isAtBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 10;
                    if (!isAtBottom) {
                        scrollToBottomBtn.classList.remove("hidden"); // â–¼ ë²„íŠ¼ ë³´ì´ê¸°
                    } else {
                        scrollToBottomBtn.classList.add("hidden"); // â–¼ ë²„íŠ¼ ìˆ¨ê¹€
                    }
                } else {
                    scrollToBottomBtn.classList.add("hidden"); // ì±„íŒ…ì°½ì´ ìˆ¨ê²¨ì§„ ê²½ìš° â–¼ ë²„íŠ¼ ìˆ¨ê¹€
                }
            }

            if (toggleButton) {
                toggleButton.addEventListener("click", function () {
                    if (isChatHidden) {
                        // ì±„íŒ… íŒ¨ë„ ë‹¤ì‹œ í‘œì‹œ
                        isScrollPaused = true; // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì ì‹œ ë©ˆì¶¤
                        content1.style.width = "400px";
                        map.style.flexGrow = "1";
                        toggleButton.innerHTML = "&lt;&nbsp;";

                        setTimeout(() => {
                            isScrollPaused = false; // ì¼ì • ì‹œê°„ í›„ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì¬ê°œ
                            // chatMessages.dispatchEvent(new Event("scroll")); // ìŠ¤í¬ë¡¤ ê°•ì œ íŠ¸ë¦¬ê±°
                        }, 100); // 100ms ëŒ€ê¸° í›„ ì¬ê°œ
                    } else {
                        // ì±„íŒ… íŒ¨ë„ ìˆ¨ê¹€
                        content1.style.width = "0";
                        map.style.flexGrow = "2";
                        toggleButton.innerHTML = "&gt;&nbsp;";
                        if (scrollToBottomBtn) {
                            scrollToBottomBtn.classList.add("hidden"); // â–¼ ë²„íŠ¼ ìˆ¨ê¹€
                        }
                    }
                    isChatHidden = !isChatHidden; // ìƒíƒœ ë³€ê²½
                });
            }

            if (chatMessages && scrollToBottomBtn) {
                chatMessages.addEventListener("scroll", scrollHandler);
                scrollToBottomBtn.addEventListener("click", function () {
                    // â–¼ ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    scrollToBottomBtn.classList.add("hidden"); // ë²„íŠ¼ ìˆ¨ê¹€
                });
            }
            
            // 1) Planner Panel
            const plannerPanel = document.getElementById("plannerPanel");
            if (plannerPanel) {
                console.log("[Planner] panel detected!");                
                const resetButton = document.getElementById("resetButton");
                const plannerTitle = document.getElementById("planner-title");
                const changeTitle = document.getElementById("change-title");
                const chatMessages = document.getElementById('chat-messages');
                const initialMessage = localStorage.getItem('chatMessage');
                const newMessage = document.createElement("div");
                const urlParams = new URLSearchParams(window.location.search);
                const chatId = urlParams.get("chat_id");

                if (isLoggedIn) { // ë¡œê·¸ì¸ëœ ê²½ìš°
                    if (chatId) {
                        try {
                            // ì„œë²„ì—ì„œ ì œëª© ê°€ì ¸ì˜¤ê¸°
                            const response = await fetch(`/app/partials/planner/get_title/?chat_id=${encodeURIComponent(chatId)}`);
                            const result = await response.json();

                            if (result.success && result.title) {
                                plannerTitle.textContent = result.title; // ì œëª© ì—…ë°ì´íŠ¸
                            } else {
                                console.error("Failed to fetch title:", result.error || "Unknown error");
                                plannerTitle.textContent = "Default Title"; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
                            }
                            // ì±„íŒ… ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                            fetch(`/app/partials/planner/get_chat_content/?chat_id=${encodeURIComponent(chatId)}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Failed to fetch chat content: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success && data.content) {
                                        parseAndDisplayChatContent(data.content); // ì±„íŒ… ë‚´ìš© íŒŒì‹± ë° UI í‘œì‹œ
                                    } else {
                                        console.log("No content for the provided chat_id.");
                                    }
                                })
                                .catch(error => {
                                    console.error("Error fetching chat content:", error);
                                });
                        } catch (error) {
                            console.error("Error fetching title or chat content:", error);
                            plannerTitle.textContent = "Default Title"; // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’
                        }
                    } else {
                        // chat_idê°€ ì—†ëŠ” ê²½ìš°, ìƒˆë¡œìš´ ì œëª© ìƒì„±
                        try {
                            const response = await fetch("/app/partials/chatting/");
                            const html = await response.text();

                            const tempDiv = document.createElement("div");
                            tempDiv.innerHTML = html;

                            const chatItems = tempDiv.querySelectorAll(".chat-item");
                            const chatCount = chatItems.length;

                            const newTitle = `chat${chatCount + 1}`;
                            plannerTitle.textContent = newTitle;
                        } catch (error) {
                            console.error("Error calculating chat count:", error);
                            plannerTitle.textContent = "chat1"; // ê¸°ë³¸ê°’ ì„¤ì •
                        }
                    }
                } 
                else {
                    try {
                        const response = await fetch("/app/partials/chatting/");
                        const html = await response.text();

                        const tempDiv = document.createElement("div");
                        tempDiv.innerHTML = html;

                        const chatItems = tempDiv.querySelectorAll(".chat-item");
                        const chatCount = chatItems.length;

                        plannerTitle.textContent = `chat1`;
                    } catch (error) {
                        console.error("Error calculating chat count:", error);
                    }
                }

                if (initialMessage) {
                    saveChatToDB(`<ë‚˜>${initialMessage}`);
                    newMessage.className = "bubble right-bubble";
                    newMessage.innerHTML = initialMessage.replace(/\n/g, "<br>");
                    chatMessages.appendChild(newMessage);
                    
                    const loadingBubble = document.createElement("div");
                    loadingBubble.classList.add("bubble", "left-bubble", "loading-bubble");
                    loadingBubble.innerHTML = `
                        <div class="loader">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    `;
                    chatMessages.appendChild(loadingBubble);
                            
                    try {
                        const gptResponse = await fetchGPTResponse(initialMessage);

                        if (gptResponse) {
                            console.log("ë´‡1:", gptResponse);
                            saveChatToDB(`<ë´‡>${gptResponse}`);
                            // GPT ì‘ë‹µ í‘œì‹œ
                            const botBubble = document.createElement("div");
                            botBubble.classList.add("bubble", "left-bubble");
                            botBubble.addEventListener("mouseenter", function (event) {
                                const currentBackgroundColor = window.getComputedStyle(this).backgroundColor;
                                if (botBubble.className.includes("left-bubble")) {
                                    this.style.backgroundColor = "#589258"; // ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ
                                }
                            });

                            botBubble.addEventListener("mouseleave", function (event) {
                                const target = event.target;
                                const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                                if (botBubble.className.includes("left-bubble")) {
                                    this.style.backgroundColor = ""; // ì›ë˜ ë°°ê²½ìƒ‰ ë³µêµ¬
                                }
                            });

                            botBubble.addEventListener("click", function (event) {
                                const target = event.target;
                                const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                                const messageContent = this.innerHTML.trim(); // ë©”ì‹œì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                                
                                if (botBubble.className.includes("left-bubble")) {
                                    // ì„œì‹ì„ ìœ ì§€í•œ ìƒíƒœë¡œ ì¶œë ¥
                                    const panelTitle = document.getElementById("panel-title");
                                    panelTitle.textContent = "";
                                    const formattedMessage = messageContent
                                        .replace(/<br\s*\/?>/gi, "\n") // <br> íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
                                        .replace(/&nbsp;/g, " ");     // &nbsp;ë¥¼ ê³µë°±ìœ¼ë¡œ ë³€í™˜

                                    const jsonData = parseItineraryToJson(formattedMessage);
                                    if (jsonData.length > 0) {
                                        generateDayButtons(jsonData);
                                        generateDynamicPlanContent(jsonData);

                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                                    }
                                }
                            });
                            chatMessages.appendChild(botBubble); // DOMì— ì¶”ê°€
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            typeText(botBubble, gptResponse, loadingBubble);
                        } else {
                            console.error("GPT ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    } catch (error) {
                        console.error("Error fetching GPT response:", error);
                        chatMessages.removeChild(loadingBubble); // ì˜¤ë¥˜ ì‹œ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‚­ì œ
                    }                    
                }             

                if (plannerTitle) {
                    plannerTitle.addEventListener("dblclick", function () {
                        changeTitle.value = plannerTitle.textContent;
                        changeTitle.style.display = "block"; // ì…ë ¥ì°½ í‘œì‹œ
                        plannerTitle.style.display = "none"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
                        changeTitle.focus();
                    });

                    // 2) Enter: ì œëª© ì €ì¥, ESC: ì·¨ì†Œ
                    changeTitle.addEventListener("keydown", async function (e) {
                        if (event.key === "Enter") {
                            const newTitle = changeTitle.value.trim();
                            const titleText = document.getElementById("planner-title"); 
                            
                            if (!newTitle) {
                                alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                return;
                            }

                            plannerTitle.style.display = "block"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ í‘œì‹œ
                            changeTitle.style.display = "none"; // ì…ë ¥ì°½ ìˆ¨ê¹€

                            try {
                                // ì¤‘ë³µ í™•ì¸ API í˜¸ì¶œ
                                const response = await fetch("/app/partials/planner/check_duplicate_title/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCSRFToken(),
                                    },
                                    body: JSON.stringify({ title: newTitle }),
                                });

                                const result = await response.json();

                                if (result.is_duplicate) {
                                    alert("ì¤‘ë³µëœ ì œëª©ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                    return;
                                }

                                // ì œëª© ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
                                const updateResponse = await fetch("/app/partials/planner/update_title/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCSRFToken(),
                                    },
                                    body: JSON.stringify({ chat_id: chatId, title: newTitle }),
                                });

                                const updateResult = await updateResponse.json();
                                if (updateResult.success) {
                                    plannerTitle.textContent = newTitle;
                                    plannerTitle.style.display = "block";
                                    changeTitle.style.display = "none";
                                } else {
                                    console.error("Failed to update title:", updateResult.error || "Unknown error");
                                }
                            } catch (error) {
                                console.error("Error checking/updating title:", error);
                            }
                        } else if (event.key === "Escape") {
                            plannerTitle.style.display = "block"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ í‘œì‹œ
                            changeTitle.style.display = "none";  // ì…ë ¥ì°½ ìˆ¨ê¹€
                        }                    
                    });
                }                

                resetButton.addEventListener("click", function () {
                    // URLì—ì„œ chat_id ì¶”ì¶œ
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatId = urlParams.get("chat_id");
                    console.log("ChatID:", chatId);

                    if (!chatId) {
                        // alert("ì‚­ì œí•  chat_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // ì‚¬ìš©ì í™•ì¸
                    const confirmReset = confirm("ì •ë§ ì´ ì±„íŒ… ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                    if (!confirmReset) return;

                    // ì„œë²„ë¡œ ì‚­ì œ ìš”ì²­
                    fetch("/app/partials/planner/init_chat/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                        body: JSON.stringify({ chat_id: chatId }),
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                alert("ì±„íŒ… ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                // UIì—ì„œ ë‚´ìš©ì„ ë¹„ì›ë‹ˆë‹¤.
                                const chatMessages = document.getElementById("chat-messages");
                                if (chatMessages) chatMessages.innerHTML = "";
                            } else {
                                alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                            }
                        })
                        .catch(error => {
                            console.error("Error resetting chat content:", error);
                            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        });
                });
            }
            
            // 2) Chatting Panel
            const chattingPanel = document.getElementById("chattingPanel");
            if (chattingPanel) {
                console.log("[Chatting] panel detected!");

                const chatList = document.querySelector(".chat-list");

                function updateChatListScroll() {
                    if (chatList.children.length > 10) {
                        chatList.classList.remove("fewer-than-ten");
                    } else {
                        chatList.classList.add("fewer-than-ten");
                    }
                }

                // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
                updateChatListScroll();

                // ì±„íŒ… ì•„ì´í…œì´ ì¶”ê°€ë˜ê±°ë‚˜ ì œê±°ë  ë•Œ ì‹¤í–‰ (ì˜ˆì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ)
                document.addEventListener("chatListUpdated", updateChatListScroll);

                // ì±„íŒ… ì‚­ì œ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì±„íŒ…ì„ ì‚­ì œí•¨
                const deleteIcons = document.querySelectorAll(".delete-icon");
                deleteIcons.forEach((icon) => {
                    icon.addEventListener("click", async function (e) {
                        e.stopPropagation();

                        const chatId = this.dataset.id;
                        if (!chatId) return;

                        const confirmed = confirm("Are you sure you want to delete this chat?");
                        if (!confirmed) return;

                        try {
                            const response = await fetch("/app/partials/chatting/delete/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken(),
                                },
                                body: JSON.stringify({ chatting_id: chatId }),
                            });

                            const result = await response.json();
                            if (result.success) {
                                alert("Chat deleted successfully!");
                                this.closest(".chat-item").remove(); // UIì—ì„œ ì‚­ì œ
                            } else {
                                alert(`Error: ${result.error || "Failed to delete chat."}`);
                            }
                        } catch (error) {
                            console.error("Error deleting chat:", error);
                            alert("An error occurred. Please try again.");
                        }
                    });
                });

                // chat-item í´ë¦­ -> /app/planner/?chat_id=xxx í˜•íƒœ (250118:ë­í•˜ëŠ” ì½”ë“œì§€?)
                document.querySelectorAll(".chat-item").forEach(item => {
                    item.addEventListener("click", function() {
                        const chatId = this.getAttribute("data-chat-id");
                        const targetUrl = `/app/planner/?chat_id=${encodeURIComponent(chatId)}`;
                        history.pushState(null, '', targetUrl);
                        loadContent(targetUrl);
                    });
                });
            }
            
            // 3) Favorites Panel
            const favoritesPanel = document.getElementById("favoritesPanel");
            if (favoritesPanel) {
                console.log("[Favorites] favoritesPanel detected!");
                // --------------------------------
                // (A) íƒ­ ì „í™˜ ë¡œì§
                // --------------------------------
                const backBtn = document.getElementById('backBtn');
                const bookmarkTitle = document.getElementById('bookmark_title');
                const placeBtn = document.getElementById('placeBtn');
                const scheduleBtn = document.getElementById('scheduleBtn');
                const topmenu = document.querySelector('.top-menu');
                const placesSection = document.getElementById('placesSection');
                const scheduleSection = document.getElementById('scheduleSection');
                const bodyElement = document.body; // í…Œë§ˆë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ body ìš”ì†Œ

                //ì¦ê²¨ì°¾ê¸° í˜ì´ì§€ì—ì„œ ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ê¸°ëŠ¥
                backBtn.addEventListener('click', () => {
                    backBtn.style.display = "none";
                    bookmarkTitle.style.display = "none";
                    placeBtn.style.display = "block";
                    scheduleBtn.style.display = "block";
                    topmenu.style.justifyContent = "space-evenly";
                    document.querySelector('.folder-list').style.display = "block";
                    document.querySelector('.bookmark-place-item').style.display = "none";
                    document.querySelector('.bookmark-schedule-item').style.display = "none";

                    const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                    const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                    const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                    
                    if (AllFolderLists) {
                        AllFolderLists.forEach(folderList => {
                            folderList.style.display = "block";
                        });
                    }
                });

                //ì¦ê²¨ì°¾ê¸° í˜ì´ì§€ì—ì„œ ì¥ì†Œ / ì¼ì • ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ê¸°ëŠ¥
                if (placeBtn && scheduleBtn && placesSection && scheduleSection) {
                    placeBtn.addEventListener('click', function() {
                        placesSection.style.display = 'block';
                        scheduleSection.style.display = 'none';

                        placeBtn.style.backgroundColor = '#999';
                        scheduleBtn.style.backgroundColor = '';

                        topmenu.style.justifyContent = "space-evenly";
                        backBtn.style.display = "none";
                        bookmarkTitle.style.display = "none";
                        placeBtn.style.display = "block";
                        scheduleBtn.style.display = "block";
                    });

                    scheduleBtn.addEventListener('click', function() {
                        scheduleSection.style.display = 'block';
                        placesSection.style.display = 'none';

                        scheduleBtn.style.backgroundColor = '#999';
                        placeBtn.style.backgroundColor = '';

                        topmenu.style.justifyContent = "space-evenly";
                        backBtn.style.display = "none";
                        bookmarkTitle.style.display = "none";
                        placeBtn.style.display = "block";
                        scheduleBtn.style.display = "block";
                    });

                    placeBtn.click();
                }
                
                // --------------------------------
                // (C) ì¥ì†Œ í´ë” ë§Œë“¤ê¸° ë¡œì§
                // --------------------------------
                
                const plusPlace = document.getElementById("plus-place");
                addFolderEventHandler(
                    "plus-place",
                    "#placesSection",
                    "ìƒˆ í´ë” ì´ë¦„ ì…ë ¥ (Enter)",
                    true,
                    { light: "/static/images/folder_light.png", dark: "/static/images/folder_dark.png" }
                );
                
                // --------------------------------
                // (D) ì¼ì • ë§Œë“¤ê¸° ë¡œì§
                // --------------------------------
                
                const plusSchedule = document.getElementById("plus-schedule");
                addFolderEventHandler(
                    "plus-schedule",
                    "#scheduleSection",
                    "ìƒˆ ì¼ì • ì´ë¦„ ì…ë ¥ (Enter)",
                    false,
                    { light: "/static/images/schedule_light.png", dark: "/static/images/schedule_dark.png" }
                );
                // --------------------------------------------------------
                // (E) í˜ì´ì§€ ë¡œë“œ ì‹œ, ê¸°ì¡´ ì•„ì´í…œë“¤ì—ë„ ì‚­ì œ ì´ë²¤íŠ¸ ì—°ê²°
                // --------------------------------------------------------
                // ë§Œì•½ "ê¸°ì¡´ ì•„ì´í…œ"ì—ë„ ì‚­ì œ ì•„ì´ì½˜ì´ ìˆë‹¤ë©´ ì ìš©
                const allFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                allFolderLists.forEach(listEl => {
                    // í•´ë‹¹ ì„¹ì…˜ì´ "ì¥ì†Œ" ì„¹ì…˜ì´ë©´ plusPlaceë¥¼, 
                    // "ì¼ì •" ì„¹ì…˜ì´ë©´ plusScheduleì„ ì—°ê²°í•´ì•¼ í•¨
                    let plusBtn = null;
                    if (listEl.closest('#placesSection')) {
                        plusBtn = plusPlace;
                    } else if (listEl.closest('#scheduleSection')) {
                        plusBtn = plusSchedule;
                    }
                    // ì•„ì´í…œ ìŠ¤ìº”
                    const items = listEl.querySelectorAll('.folder-item');
                    items.forEach(item => attachDeleteEvent(item, listEl, plusBtn));

                    // ì´ˆê¸° ìŠ¤í¬ë¡¤/ë²„íŠ¼ìƒíƒœ ê°±ì‹ 
                    updateFolderListUI(listEl, plusBtn);
                });

                const folderItems = document.querySelectorAll(".folder-item");
                // ê° folder-itemì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                folderItems.forEach(item => {
                    item.addEventListener("click", async function () {
                        if (event.target.classList.contains("delete-icon")) {
                            return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ folder-itemì˜ ì´ë²¤íŠ¸ ì‹¤í–‰ ì°¨ë‹¨
                        }
                        
                        // ìƒˆ í´ë” ë²„íŠ¼ì€ í•´ë‹¹ ì•ˆí•˜ë‹ˆê¹Œ íŒ¨ìŠ¤
                        if (item.id !== "plus-place" && item.id !== "plus-schedule") {
                            const backBtn = document.getElementById('backBtn');
                            const backbookmarkTitleBtn = document.getElementById('bookmark_title');
                            const placeBtn = document.getElementById('placeBtn');
                            const scheduleBtn = document.getElementById('scheduleBtn');
                            const topmenu = document.querySelector('.top-menu');
                            const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                            const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                            const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                            
                            if (AllFolderLists) {
                                AllFolderLists.forEach(folderList => {
                                    folderList.style.display = "none";
                                });
                            }
                            
                            topmenu.style.justifyContent = "start";
                            backBtn.style.display = "block";
                            backbookmarkTitleBtn.style.display = "block";
                            backbookmarkTitleBtn.textContent = item.textContent.trim().replace(/\s{2,}/g, '').replace(/\u00a0+/g, '');
                            placeBtn.style.display = "none";
                            scheduleBtn.style.display = "none";

                            // bookmark-place-itemê³¼ bookmark-schedule-item ì´ˆê¸°í™”
                            if (bookmarkPlaceItemDiv) {                            
                                bookmarkPlaceItemDiv.style.display = "none";
                                bookmarkPlaceItemDiv.innerHTML = ""; // ê¸°ì¡´ ìì‹ ìš”ì†Œ ì œê±°
                            }
                            if (bookmarkScheduleItemDiv) {
                                bookmarkScheduleItemDiv.style.display = "none";
                                bookmarkScheduleItemDiv.innerHTML = ""; // ê¸°ì¡´ ìì‹ ìš”ì†Œ ì œê±°
                            }
                            
                            const bookmarkId = this.id; // í´ë¦­ëœ divì˜ ID ê°€ì ¸ì˜¤ê¸°
                            if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                return; // "ìƒˆ í´ë”" ë²„íŠ¼ í´ë¦­ ì‹œ ë¬´ì‹œ
                            }

                            try {
                                // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                const response = await fetch(`/app/partials/favorites/get_bookmark_items/${bookmarkId}/`, {
                                    method: "GET",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                });

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const data = await response.json();
                                if (data.type === "place") {
                                    // ì¥ì†Œ ì¦ê²¨ì°¾ê¸°
                                    if (bookmarkPlaceItemDiv) {
                                        bookmarkPlaceItemDiv.style.display = "block";

                                        data.rows.forEach(row => {
                                            const itemDiv = document.createElement("div");
                                            itemDiv.className = "place-item";
                                            itemDiv.id = row.id;
                                            itemDiv.innerHTML = `
                                                <p style="display: flex; align-items: center;"><strong>ì´ë¦„:</strong> ${row.name}</p>
                                            `;
                                            itemDiv.addEventListener("click", async () => {
                                                //DBì—ì„œ í•´ë‹¹ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                                                document.querySelectorAll(".place-item").forEach(folder => {                                                
                                                    folder.style.backgroundColor = ""; // ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µì› (CSS ì´ˆê¸°ê°’)
                                                });
                                                document.getElementById("getBookmarkListBtn").textContent = "â˜…";
                                                itemDiv.style.backgroundColor = "#999";

                                                const bookmarkId = this.id; // folder-itemì˜ ID ê°’
                                                if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                                    return; // "ìƒˆ í´ë”" ë²„íŠ¼ì€ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                                                }

                                                try {
                                                    // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                                    const response = await fetch(`/app/partials/favorites/bookmark-place-detail/${row.id}/`, {
                                                        method: "GET",
                                                        headers: {
                                                            "Content-Type": "application/json",
                                                        },
                                                    });

                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }
                                                    
                                                    // UI ì—…ë°ì´íŠ¸: map-panel-content ë˜ëŠ” ë‹¤ë¥¸ ìš”ì†Œì— ë°ì´í„° í‘œì‹œ
                                                    const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±
                                                    const mapPanelContent = document.querySelector(".map-panel-content");
                                                    if (!mapPanelContent) {
                                                        console.error("map-panel-content element not found");
                                                        return;
                                                    }

                                                    // ê¸°ì¡´ ë‚´ìš© ì œê±°
                                                    mapPanelContent.innerHTML = "";

                                                    // ì¥ì†Œ ì •ë³´ í‘œì‹œ
                                                    if (data) {
                                                        const panelTitle = document.getElementById("panel-title");                                                        
                                                        panelTitle.innerHTML = `${row.name}`;
                                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                                        getBookmarkListBtn.classList.remove("schedule");
                                                        getBookmarkListBtn.classList.add("place");
                                                        getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                                        getBookmarkListBtn.setAttribute("bookmarkplace_id", row.id);
                                                        getBookmarkListBtn.setAttribute("json_data", null);
                                                        const placeSection = document.createElement("div");
                                                        placeSection.className = "place-section";
                                                        placeSection.innerHTML = `
                                                            <h3>ì¥ì†Œ ì •ë³´</h3>
                                                            <p><strong>ì´ë¦„:</strong> ${data.name}</p>
                                                            <p><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
                                                            <p><strong>ì„¤ëª…:</strong> ${data.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."}</p>
                                                        `;
                                                        mapPanelContent.appendChild(placeSection);
                                                        if (data.longitude && data.latitude && data.name) {
                                                            const markerData = [];
                                                            markerData.push({
                                                                position: new naver.maps.LatLng(data.latitude, data.longitude),
                                                                title: data.name,
                                                                icon: `https://chart.googleapis.com/chart?chst=d_map_pin_number&chld=${markerData.length + 1}|FF0000|000000`,
                                                            });
                                                            addMarkersToMap(markerData);
                                                        }
                                                        else if (data.address && data.name) {
                                                            const addresses = [];
                                                            addresses.push({
                                                                address: data.address,
                                                                title: data.name,
                                                            })
                                                            globalMarkerData = await getCoordinates(addresses);
                                                            addMarkersToMap(globalMarkerData);
                                                        }
                                                        else {
                                                            console.log("dataì— ë“  ê²Œ í•˜ë‚˜ë„ ì—†ìœ¼ë‹ˆ ë§ˆì»¤ë¥¼ ë„ìš°ê¸¸ í¬ê¸°");
                                                        }
                                                    } else {
                                                        const noDataMessage = document.createElement("p");
                                                        noDataMessage.textContent = "í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                                                        mapPanelContent.appendChild(noDataMessage);
                                                    }
                                                } catch (error) {
                                                    console.error("Error fetching bookmark place data:", error);
                                                }
                                            });

                                            // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                                            const deleteButton = document.createElement('img');
                                            deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                                ? '/static/images/delete_light.png' 
                                                : '/static/images/delete_dark.png';
                                            deleteButton.style.cursor = 'pointer';
                                            deleteButton.style.marginLeft = 'auto';
                                            deleteButton.style.marginRight = '10px';
                                            deleteButton.style.opacity = '0.7';
                                            deleteButton.width = 25;
                                            deleteButton.height = 25;

                                            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                                            deleteButton.addEventListener('click', (event) => {
                                                event.stopPropagation();
                                                // UIì—ì„œ ì œê±°
                                                bookmarkPlaceItemDiv.removeChild(itemDiv);

                                                //DBì—ì„œë„ í•´ë‹¹ ë°ì´í„° ì œê±°
                                                console.log("bookmarkplace_id:", row.bookmark); //bm_00001
                                                console.log("data:", row.id); 
                                                deleteBookmarklist(row);
                                            });

                                            deleteButton.addEventListener('mouseover', () => {
                                                deleteButton.style.opacity = '1.0';
                                            });

                                            deleteButton.addEventListener('mouseleave', () => {
                                                deleteButton.style.opacity = '0.7';
                                            });

                                            itemDiv.appendChild(deleteButton);
                                            bookmarkPlaceItemDiv.appendChild(itemDiv);
                                        });
                                    }
                                } 
                                else if (data.type === "schedule") {
                                    // ì¼ì • ì¦ê²¨ì°¾ê¸°
                                    if (bookmarkScheduleItemDiv) {
                                        bookmarkScheduleItemDiv.style.display = "block";

                                        data.rows.forEach(row => {
                                            const itemDiv = document.createElement("div");
                                            itemDiv.className = "schedule-item";
                                            itemDiv.id = row.id;
                                            itemDiv.innerHTML = `
                                                <p style="display: flex; align-items: center;"><strong>ì´ë¦„:</strong> ${row.name}</p>
                                            `;
                                            itemDiv.addEventListener("click", async () => {
                                                document.querySelectorAll(".schedule-item").forEach(folder => {                                                
                                                    folder.style.backgroundColor = ""; // ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µì› (CSS ì´ˆê¸°ê°’)
                                                });

                                                document.getElementById("getBookmarkListBtn").textContent = "â˜…";
                                                itemDiv.style.backgroundColor = "#999";

                                                const bookmarkId = this.id; // folder-itemì˜ ID ê°’
                                                if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                                    return; // "ìƒˆ í´ë”" ë²„íŠ¼ì€ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                                                }

                                                try {
                                                    // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                                    const response = await fetch(`/app/partials/favorites/bookmark-schedule-detail/${row.id}/`, {
                                                        method: "GET",
                                                        headers: {
                                                            "Content-Type": "application/json",
                                                        },
                                                    });

                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }

                                                    // UI ì—…ë°ì´íŠ¸: map-panel-content ë˜ëŠ” ë‹¤ë¥¸ ìš”ì†Œì— ë°ì´í„° í‘œì‹œ
                                                    const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±
                                                    const mapPanelContent = document.querySelector(".map-panel-content");
                                                    if (!mapPanelContent) {
                                                        console.error("map-panel-content element not found");
                                                        return;
                                                    }

                                                    // ê¸°ì¡´ ë‚´ìš© ì œê±°
                                                    mapPanelContent.innerHTML = "";

                                                    // ì¼ì • ì •ë³´ í‘œì‹œ
                                                    if (data) {;
                                                        const panelTitle = document.getElementById("panel-title");
                                                        panelTitle.innerHTML = `${row.name}`;
                                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                                        getBookmarkListBtn.classList.remove("place");
                                                        getBookmarkListBtn.classList.add("schedule");
                                                        getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                                        getBookmarkListBtn.setAttribute("bookmarkschedule_id", row.id);
                                                        const jsonData = data.json_data;
                                                        console.log("werewr:", jsonData);
                                                        if (typeof json_data === "string") {
                                                            jsonData = JSON.parse(data.json_data);
                                                        }    
                                                        getBookmarkListBtn.setAttribute("json_data", jsonData);
                                                        generateDayButtons(jsonData);
                                                        generateDynamicPlanContent(jsonData);
                                                    } else {
                                                        const noDataMessage = document.createElement("p");
                                                        noDataMessage.textContent = "í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                                                        mapPanelContent.appendChild(noDataMessage);
                                                    }
                                                } catch (error) {
                                                    console.error("Error fetching bookmark place data:", error);
                                                }
                                            });

                                            // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                                            const deleteButton = document.createElement('img');
                                            deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                                ? '/static/images/delete_light.png' 
                                                : '/static/images/delete_dark.png';
                                            deleteButton.style.cursor = 'pointer';
                                            deleteButton.style.marginLeft = 'auto';
                                            deleteButton.style.marginRight = '10px';
                                            deleteButton.style.opacity = '0.7';
                                            deleteButton.width = 25;
                                            deleteButton.height = 25;

                                            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                                            deleteButton.addEventListener('click', (event) => {
                                                event.stopPropagation();
                                                // UIì—ì„œ ì œê±°  
                                                itemDiv.remove();

                                                //DBì—ì„œë„ í•´ë‹¹ ë°ì´í„° ì œê±°
                                                console.log("bookmarkplace_id:", row.bookmark); //bm_00001
                                                console.log("data:", row.id); 
                                                deleteBookmarklist(row);
                                            });

                                            deleteButton.addEventListener('mouseover', () => {
                                                deleteButton.style.opacity = '1.0';
                                            });

                                            deleteButton.addEventListener('mouseleave', () => {
                                                deleteButton.style.opacity = '0.7';
                                            });

                                            itemDiv.appendChild(deleteButton);
                                            bookmarkScheduleItemDiv.appendChild(itemDiv);
                                        });
                                    }
                                }
                                else {
                                    console.log("No data found");
                                }
                            } catch (error) {
                                console.error("Error fetching bookmark data:", error);
                            }
                        }
                    });
                });
            
            } // if (favoritesPanel)
            
            // 4) Settings Panel
            const settingsPanel= document.getElementById("settingsPanel");
            if (settingsPanel) {
                console.log("[settings] panel detected!");
                const lightBox = document.getElementById('light');
                const darkBox = document.getElementById('dark');
                const lightRadio = document.querySelector("input[name='theme'][value='light']");
                const darkRadio = document.querySelector("input[name='theme'][value='dark']");
                const themeRadios = document.querySelectorAll('input[name="theme"]');

                function selectTheme(theme) {
                    lightBox.classList.remove('selected');
                    darkBox.classList.remove('selected');

                    if (theme === 'light') {
                        lightBox.classList.add('selected');
                        lightRadio.checked = true;
                    } else if (theme === 'dark') {
                        darkBox.classList.add('selected');
                        darkRadio.checked = true;
                    }
                }

                lightBox.addEventListener('click', () => selectTheme('light'));
                darkBox.addEventListener('click', () => selectTheme('dark'));

                // í…Œë§ˆ ì„ íƒ ë³€ê²½ ì‹œ ì„œë²„ì— ì—…ë°ì´íŠ¸
                themeRadios.forEach(radio => {
                    radio.addEventListener("change", () => {
                        const isLightTheme = radio.value === "light";
                        document.body.setAttribute("data-theme", isLightTheme ? "light" : "dark");
                        updateIconsBasedOnTheme();
                        
                        fetch("/app/partials/settings/update_theme/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCSRFToken(),
                            },
                            body: JSON.stringify({ is_white_theme: isLightTheme }),
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error("Theme update failed.");
                                }
                                console.log("Theme updated successfully.");
                            })
                            .catch((err) => console.error("Error updating theme:", err));
                    });
                });

                const initialTheme = document.body.getAttribute("data-theme") === "light";
                updateIconsBasedOnTheme(initialTheme);

                const languageSelect = document.getElementById('language');
                if (languageSelect) {
                    languageSelect.addEventListener('change', async () => {
                        const selectedLanguage = languageSelect.value;

                        try {
                            const response = await fetch('/app/partials/settings/update_language/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken(), // CSRF í† í° ì¶”ê°€
                                },
                                body: JSON.stringify({ language: selectedLanguage }),
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();
                            if (result.success) {
                                // alert("Language updated successfully.");
                            } else {
                                alert(`Error: ${result.message}`);
                            }
                        } catch (error) {
                            console.error("Error updating language:", error);
                            alert("Failed to update language. Please try again.");
                        }
                    });
                }
            }

            // 5) Profile Panel
            const profilePanel = document.getElementById("profilePanel");
            if (profilePanel) {
                console.log("[profile] panel detected!");

                const profileImage = document.getElementById("profile-image");
                const popup = document.getElementById("image-popup");
                const popupImages = document.querySelectorAll(".popup-image");
                
                // í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ íŒì—… í‘œì‹œ
                profileImage.addEventListener("click", function () {
                    popup.classList.remove("hidden");
                    toggleButton.classList.add("hidden");
                });

                // íŒì—… ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì„œë²„ë¡œ thumbnail_id ì—…ë°ì´íŠ¸
                popupImages.forEach(image => {
                    image.addEventListener("click", function () {
                        const selectedId = this.dataset.id;

                        // ì„œë²„ë¡œ AJAX ìš”ì²­
                        fetch("/app/partials/profile/update_thumbnail/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCSRFToken()
                            },
                            body: JSON.stringify({ thumbnail_id: selectedId })
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    // ì„±ê³µ ì‹œ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                                    profileImage.src = `/static/images/profiles/profile_${selectedId}.jpg`;                                    
                                } else {
                                    alert("Failed to update profile image: " + data.error);
                                }
                                popup.classList.add("hidden");
                                toggleButton.classList.remove("hidden");
                            })
                            .catch(err => {
                                console.error("Error updating profile image:", err);
                            });
                    });
                });

                // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                if (popup) {
                    popup.addEventListener("click", function (e) {
                        if (e.target === popup) {
                            popup.classList.add("hidden");
                            toggleButton.classList.remove("hidden");
                        }
                    });
                }

                // 1) ë‹‰ë„¤ì„ ìˆ˜ì •
                const nicknameText  = document.getElementById('nickname-text');
                const nicknameInput = document.getElementById('nickname-input');
                const editButton    = document.getElementById('edit-btn');
                const logoutBtn     = document.getElementById("logout-btn");

                let oldNickname = nicknameText ? nicknameText.textContent : "";

                let escNote = document.createElement("div");
                escNote.style.color = "#999";      // ì˜ˆì‹œ ìŠ¤íƒ€ì¼
                escNote.style.fontSize = "0.9rem"; // ì˜ˆì‹œ
                escNote.textContent = "(ENTER: edit / ESC: cancel)";

                if (editButton && nicknameText && nicknameInput) {
                    editButton.addEventListener("click", function() {
                        // ì—°í•„ ë²„íŠ¼ í´ë¦­ ì‹œ
                        oldNickname = nicknameText.textContent; // í˜„ì¬ ë‹‰ë„¤ì„ ì €ì¥
                        nicknameText.classList.add("hidden");   // ìˆ¨ê¹€
                        nicknameInput.classList.remove("hidden");
                        nicknameInput.value = oldNickname;      // ì…ë ¥ì°½ ì´ˆê¸°ê°’
                        nicknameInput.focus();

                        const wrapper = document.querySelector(".nickname-wrapper");
                        if (wrapper) {
                            wrapper.appendChild(escNote);
                        }
                    });

                    // (1) Enter -> ì €ì¥
                    nicknameInput.addEventListener("keydown", function(e) {
                        if (e.key === "Enter") {
                            const newNickname = nicknameInput.value.trim();
                            if (newNickname) {
                                nicknameText.textContent = newNickname;
                            }
                            nicknameText.classList.remove("hidden");
                            nicknameInput.classList.add("hidden");

                            // ì•ˆë‚´ ë¬¸êµ¬ ì œê±°
                            removeEscNote();

                            // ì„œë²„ë¡œ AJAX ìš”ì²­
                            fetch("/app/partials/profile/update_nickname/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken(),
                                },
                                body: JSON.stringify({ nickname: newNickname }),
                            })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json(); // JSON íŒŒì‹±
                            })
                            .then((data) => {
                                if (data.success) {
                                    // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
                                    nicknameText.textContent = newNickname;
                                } else {
                                    alert("ë‹‰ë„¤ì„ ìˆ˜ì • ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                                }
                            })
                            .catch((err) => {
                                console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + err.message);
                            })
                            .finally(() => {
                                // ì…ë ¥ì°½ ìˆ¨ê¸°ê³  ë¼ë²¨ ë³´ì´ê¸°
                                nicknameInput.classList.add("hidden");
                                nicknameText.classList.remove("hidden");
                            });
                        }
                        // (2) ESC -> ì·¨ì†Œ (ì›ë˜ ë‹‰ë„¤ì„ ë³µì›)
                        else if (e.key === "Escape") {
                            nicknameInput.value = oldNickname;
                            nicknameText.classList.remove("hidden");
                            nicknameInput.classList.add("hidden");

                            // ì•ˆë‚´ ë¬¸êµ¬ ì œê±°
                            removeEscNote();
                        }
                    });
                }

                // (4) ì•ˆë‚´ ë¬¸êµ¬ ì œê±° í•¨ìˆ˜
                function removeEscNote() {
                    if (escNote && escNote.parentNode) {
                        escNote.parentNode.removeChild(escNote);
                    }
                }

                // (5) ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", function() {
                        alert("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.");
                        window.location.href = "/";
                    });
                }

                // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì˜ˆì‹œ
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", function() {
                        alert("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•´ì£¼ì„¸ìš”.");
                        window.location.href = "/";
                    });
                }
            }
            
            // 6) ì±„íŒ… ì…ë ¥ì°½ ë¡œì§
            const inputBar = document.getElementById("input_bar");  
            const deleteBtn = document.querySelector('.delete-btn');
            const sendBtn = document.querySelector('.send-button');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', showPopup);
            }

            if (inputBar) {
                inputBar.addEventListener("keydown", function (e) {
                    inputBarKeyDown(e, isLoading, inputBar);
                });
                inputBar.addEventListener("input", resizeInput);
                // resizeInput();
            }          
            
            if (sendBtn) {
                sendBtn.addEventListener("click", function (e) {
                    if (isLoading) {
                        e.preventDefault(); // ë¡œë”© ì¤‘ì¼ ë•Œ ì…ë ¥ ë°©ì§€
                        alert("í˜„ì¬ ë´‡ ì‘ë‹µì´ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!");
                        return;
                    }

                    e.preventDefault();    
                    const chatMessages = document.getElementById("chat-messages");
                    chatMessages.scrollTop = chatMessages.scrollHeight;           
                    sendMessage();
                });
            }
            
            function inputBarKeyDown(e, isLoading, inputBar) {
                if (e.key === "Enter" && !e.shiftKey) {
                    if (isLoading) {
                        e.preventDefault(); // ë¡œë”© ì¤‘ì¼ ë•Œ ì…ë ¥ ë°©ì§€
                        alert("í˜„ì¬ ë´‡ ì‘ë‹µì´ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!");
                        return;
                    }

                    e.preventDefault();    
                    const chatMessages = document.getElementById("chat-messages");
                    chatMessages.scrollTop = chatMessages.scrollHeight;           
                    sendMessage();
                    return false;
                } 
                else if (e.key === "Enter" && e.shiftKey) {
                    e.preventDefault();
                    const cursorPosition = inputBar.selectionStart;
                    inputBar.value =
                        inputBar.value.slice(0, cursorPosition) + "\n"
                        + inputBar.value.slice(cursorPosition);
                    // resizeInput();
                    return false;
                }
            }

            async function sendMessage() {
                if (isLoading) return; // ë¡œë”© ì¤‘ì¼ ë•Œ ë©”ì‹œì§€ ì „ì†¡ ë°©ì§€

                const message = inputBar.value.trim(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë©”ì‹œì§€
                if (message === "") return;

                saveChatToDB(`<ë‚˜>${message}`);

                // 1. ë¡œë”© ìƒíƒœë¡œ ì„¤ì •
                isLoading = true;
                inputBar.disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™”

                // ì‚¬ìš©ìì˜ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
                const userMessage = document.createElement("div");
                userMessage.className = "bubble right-bubble";
                userMessage.innerHTML = message.replace(/\n/g, "<br>");
                chatMessages.appendChild(userMessage);                

                inputBar.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”

                const loadingBubble = document.createElement("div");
                loadingBubble.classList.add("bubble", "left-bubble", "loading-bubble");
                loadingBubble.innerHTML = `
                    <div class="loader">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                chatMessages.appendChild(loadingBubble);

                try {
                    // ì´ì „ AbortControllerê°€ ìˆë‹¤ë©´ ì¤‘ë‹¨
                    if (activeAbortController) {
                        activeAbortController.abort();
                    }

                    // ìƒˆë¡œìš´ AbortController ìƒì„±
                    activeAbortController = new AbortController();
                    const { signal } = activeAbortController;

                    // ì„œë²„ ìš”ì²­ (AbortControllerë¡œ ì·¨ì†Œ ê°€ëŠ¥)
                    const response = await fetchGPTResponse(message, signal);

                    if (response) {
                        const botMessage = document.createElement("div");
                        botMessage.className = "bubble left-bubble";
                        chatMessages.appendChild(botMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        botMessage.addEventListener("mouseenter", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            if (botMessage.className.includes("left-bubble")) {
                                this.style.backgroundColor = "#589258"; // ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ
                            }
                        });

                        // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì´ë²¤íŠ¸
                        botMessage.addEventListener("mouseleave", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            if (botMessage.className.includes("left-bubble")) {
                                this.style.backgroundColor = ""; // ì›ë˜ ë°°ê²½ìƒ‰ ë³µêµ¬
                            }
                        });

                        botMessage.addEventListener("click", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            const messageContent = this.innerHTML.trim(); // ë©”ì‹œì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

                            if (botMessage.className.includes("left-bubble")) {
                                const panelTitle = document.getElementById("panel-title");
                                panelTitle.textContent = "";
                                // ì„œì‹ì„ ìœ ì§€í•œ ìƒíƒœë¡œ ì¶œë ¥
                                const formattedMessage = messageContent
                                    .replace(/<br\s*\/?>/gi, "\n") // <br> íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
                                    .replace(/&nbsp;/g, " ");     // &nbsp;ë¥¼ ê³µë°±ìœ¼ë¡œ ë³€í™˜

                                const jsonData = parseItineraryToJson(formattedMessage);
                                if (jsonData.length > 0) {
                                    generateDayButtons(jsonData);
                                    generateDynamicPlanContent(jsonData);

                                    const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                    getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                                }
                            }
                        });
                        console.log("ë´‡2:", response); // botMessageì˜ HTML ë‚´ìš©ì„ ì¶œë ¥
                        saveChatToDB(`<ë´‡>${response}`); // HTML ë‚´ìš©ì„ ë¬¸ìì—´ë¡œ ì €ì¥
                        typeText(botMessage, response, loadingBubble); // íƒ€ì´í•‘ íš¨ê³¼
                    }
                } catch (error) {
                    if (error.name === "AbortError") {
                        console.log("ë¹„ë™ê¸° ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        console.error("Error fetching GPT response:", error);
                        const errorMessage = document.createElement("div");
                        errorMessage.className = "bubble left-bubble error";
                        errorMessage.innerHTML = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                        chatMessages.appendChild(errorMessage);
                    }
                } finally {
                    isLoading = false;
                    inputBar.disabled = false; // ì…ë ¥ì°½ í™œì„±í™”
                    inputBar.focus();
                }
            }
            
            async function fetchGPTResponse(userInput, signal) {
                try {
                    const response = await fetch("/app/partials/planner/run-gpt/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                        body: JSON.stringify({ question: userInput }),
                        signal, // AbortControllerì—ì„œ ë°›ì€ signal ì¶”ê°€
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.answer; // ì„œë²„ë¡œë¶€í„° ë°›ì€ ë‹µë³€
                } catch (error) {
                    if (error.name === "AbortError") {
                        console.log("ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        throw error;
                    }
                }
            }

            function resizeInput() {
                inputBar.style.height = "auto"; 
                const scrollHeight = inputBar.scrollHeight;
                const maxHeight = 120; 
                inputBar.style.height = `${Math.min(scrollHeight, maxHeight)}px`;

                if (scrollHeight >= maxHeight) {
                    inputBar.style.overflowY = "auto";
                } else {
                    inputBar.style.overflowY = "hidden";
                }
            }
        });

        function saveChatToDB(chatContent) {
            // í˜„ì¬ URLì—ì„œ chat_id ì¶”ì¶œ
            localStorage.removeItem('chatMessage');
            const urlParams = new URLSearchParams(window.location.search);
            const chatId = urlParams.get("chat_id");
            console.log("saveChatToDB CHATID:", chatId);

            fetch("/app/partials/planner/save_chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), // Django CSRF í† í°
                },
                body: JSON.stringify({
                    chat: chatContent,
                    chat_id: chatId, // URLì—ì„œ ê°€ì ¸ì˜¨ chat_idë¥¼ ì „ì†¡
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    console.error("Failed to save chat to DB:", data.error);
                    if (data.error === "ì±„íŒ… ë‚´ì—­ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤!") {
                        // chat-containerì— ì—ëŸ¬ ë©”ì‹œì§€ ë§í’ì„  ì¶”ê°€
                        const chatContainer = document.querySelector(".chat-container");
                        if (chatContainer) {
                            const errorBubble = document.createElement("div");
                            errorBubble.className = "error-bubble";
                            errorBubble.innerHTML = "ì±„íŒ… ë‚´ì—­ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤! ì´ ì±„íŒ…ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ê¸°ì¡´ ì±„íŒ… ë‚´ì—­ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.<br>í˜„ì¬ ì±„íŒ…ì—ëŠ” ê¸€ ì´ˆê¸°í™” ë²„íŠ¼ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                            errorBubble.style.position = "relative";
                            errorBubble.style.padding = "10px";
                            errorBubble.style.margin = "10px 0";
                            errorBubble.style.backgroundColor = "#ffcccc";
                            errorBubble.style.color = "#900";
                            errorBubble.style.border = "1px solid #f00";
                            errorBubble.style.borderRadius = "5px";
                            errorBubble.style.fontSize = "14px";

                            // ì´ë¯¸ ë§í’ì„ ì´ ì¡´ì¬í•˜ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                            if (!chatContainer.querySelector(".error-bubble")) {
                                chatContainer.insertBefore(errorBubble, chatContainer.firstChild); // ë§¨ ìœ„ì— ì¶”ê°€
                            }
                        } else {
                            console.error("chat-container element not found.");
                        }
                    }
                } 
                else {
                    if (data.chatting_id) {
                        console.log("chat id:", data.chatting_id, "Chat saved successfully:", data.message || "Success", chatContent);
                        // ê¸°ì¡´ì˜ chat_idê°€ ìˆì—ˆë‹¤ë©´ URLì„ ì—…ë°ì´íŠ¸
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("chat_id", data.chatting_id); 
                        window.history.replaceState(null, "", newUrl.toString());
                        lastLoadedPath = newUrl.toString();
                    }
                    if (data.new_chat_id) {
                        console.log("chat id:", data.chatting_id, "New Chat ID:", data.message || "Success", chatContent);
                        // ìƒˆ chat_idê°€ ìƒì„±ë˜ì—ˆë‹¤ë©´ URLì„ ì—…ë°ì´íŠ¸
                        const newChatId = data.new_chat_id;
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("chat_id", newChatId);
                        window.history.replaceState(null, "", newUrl.toString());
                        lastLoadedPath = newUrl.toString();
                    }
                }
            })
            .catch(error => {
                console.error("Error saving chat to DB:", error);
            });
        }

        function typeText(element, text, loadingBubble, speed = 5) {
            let index = 0;

            // ë¡œë”© ë²„ë¸” ì œê±°
            if (loadingBubble && loadingBubble.parentNode) {
                loadingBubble.parentNode.removeChild(loadingBubble);
            }

            // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬
            function typeNextChar() {
                if (index < text.length) {
                    const char = text[index] === "\n" ? document.createElement("br") : document.createTextNode(text[index]);
                    if (char instanceof Node) {
                        element.appendChild(char);
                    }
                    index++;

                    // ìŠ¤í¬ë¡¤ì„ ê°•ì œí•˜ì§€ ì•Šê³ ë„ ì‹¤í–‰
                    // element.scrollTop = element.scrollHeight;

                    setTimeout(typeNextChar, speed);
                } else {
                    // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
                    isLoading = false;
                }
            }
            typeNextChar();
        }

        function parseAndDisplayChatContent(chatContent) {
            if (!chatContent) {
                console.warn("chatContentê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            // HTML Escape ì²˜ë¦¬ ì œê±°
            chatContent = chatContent
                .replace(/&lt;/g, "<")
                .replace(/&gt;/g, ">")
                .replace(/&amp;/g, "&");

            // <ë‚˜>, <ë´‡> ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ë¶„ë¦¬
            const tokens = chatContent.split(/(<ë‚˜>|<ë´‡>)/g).filter(token => token.trim() !== "");

            const chatMessages = document.getElementById("chat-messages");
            if (!chatMessages) {
                console.error("#chat-messages ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ê¸°ì¡´ DOM ì´ˆê¸°í™”
            chatMessages.innerHTML = "";

            // ëŒ€í™” ë‚´ìš© íŒŒì‹± ë° ë Œë”ë§
            let currentSpeaker = null;
            tokens.forEach(token => {
                if (token === "<ë‚˜>") {
                    currentSpeaker = "user";
                } else if (token === "<ë´‡>") {
                    currentSpeaker = "bot";
                } else {
                    // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                    const bubble = document.createElement("div");
                    bubble.classList.add("bubble");
                    bubble.addEventListener("mouseenter", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        if (bubble.className.includes("left-bubble")) {
                            this.style.backgroundColor = "#589258"; // ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ
                        }
                    });

                    // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì´ë²¤íŠ¸
                    bubble.addEventListener("mouseleave", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        if (bubble.className.includes("left-bubble")) {
                            this.style.backgroundColor = ""; // ì›ë˜ ë°°ê²½ìƒ‰ ë³µêµ¬
                        }
                    });

                    bubble.addEventListener("click", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        const messageContent = this.innerHTML.trim(); // ë©”ì‹œì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        if (bubble.className.includes("left-bubble")) {
                            const panelTitle = document.getElementById("panel-title");
                            panelTitle.textContent = "";

                            // ì„œì‹ì„ ìœ ì§€í•œ ìƒíƒœë¡œ ì¶œë ¥
                            const formattedMessage = messageContent
                                .replace(/<br\s*\/?>/gi, "\n") // <br> íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
                                .replace(/&nbsp;/g, " ");     // &nbsp;ë¥¼ ê³µë°±ìœ¼ë¡œ ë³€í™˜

                            // Example Usage
                            const jsonData = parseItineraryToJson(formattedMessage);
                            if (jsonData.length > 0) {
                                generateDayButtons(jsonData);
                                generateDynamicPlanContent(jsonData);
    
                                const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                            }
                        }
                    });

                    // ì„œì‹ ê·¸ëŒ€ë¡œ ì¶œë ¥
                    const formattedText = token
                        .replace(/\\n/g, "<br>")   // ì¤„ë°”ê¿ˆ
                        .replace(/\\r/g, "")      // \r ì œê±°
                        .replace(/ {2}/g, "&nbsp;&nbsp;"); // ì—°ì†ëœ ë„ì–´ì“°ê¸° ì²˜ë¦¬

                    bubble.innerHTML = formattedText;

                    // ìŠ¤í”¼ì»¤ì— ë”°ë¼ ìŠ¤íƒ€ì¼ ì§€ì •
                    if (currentSpeaker === "user") {
                        bubble.classList.add("right-bubble");
                    } else if (currentSpeaker === "bot") {
                        bubble.classList.add("left-bubble");
                    }

                    chatMessages.appendChild(bubble);
                }
            });
        }

        function parseItineraryToJson(text) {
            const lines = text.split("\n");
            const result = [];
            let currentDay = null;
            let currentMeal = null;
            let currentSection = null;

            lines.forEach(line => {
                const trimmedLine = line.trim();

                if (!trimmedLine) return; // ë¹ˆ ì¤„ ë¬´ì‹œ

                const isDayHeader = trimmedLine.startsWith("###");
                const isMealHeader = trimmedLine.match(/- \*\*(ì•„ì¹¨|ì ì‹¬|ì €ë…)\*\*/);
                const isKeyValuePair = trimmedLine.startsWith("-");

                // Day header ì²˜ë¦¬
                if (isDayHeader) {
                    const dayMatch = trimmedLine.match(/^### (\d+)ì¼ì°¨/);
                    if (dayMatch) {
                        currentDay = {
                            day: parseInt(dayMatch[1]),
                            meals: {}
                        };
                        result.push(currentDay);
                    }
                    return;
                }

                // Meal header ì²˜ë¦¬
                if (isMealHeader) {
                    const mealMatch = trimmedLine.match(/- \*\*(.*?)\*\*/);
                    if (mealMatch) {
                        currentMeal = mealMatch[1];
                        if (currentDay && !currentDay.meals[currentMeal]) {
                            currentDay.meals[currentMeal] = {
                                ì‹ì‚¬ì¥ì†Œ: {
                                    ì¥ì†Œ: null,
                                    ì£¼ì†Œ: null,
                                    ì˜ì—…ì‹œê°„: null,
                                    ìŒì‹ì íŠ¹ì§•: null,
                                    ê¸°íƒ€ì •ë³´: null
                                },
                                ëª…ì†Œ: {
                                    ëª…ì†Œì´ë¦„: null,
                                    ì˜ì—…ì‹œê°„: null,
                                    ëª…ì†ŒíŠ¹ì§•: null,
                                    ëª…ì†Œìœ„ì¹˜: null,
                                    ê¸°íƒ€ì •ë³´: null
                                }
                            };
                        }
                        currentSection = null;
                    }
                    return;
                }

                // Key-Value ì²˜ë¦¬
                if (isKeyValuePair) {
                    const keyValueMatch = trimmedLine.match(/- \*\*(.*?)\*\*: (.*)/);
                    if (keyValueMatch && currentDay && currentMeal) {
                        const [, key, value] = keyValueMatch;
                        const mealSection = currentDay.meals[currentMeal];

                        // ì‹ì‚¬ ì¥ì†Œì™€ ëª…ì†Œ êµ¬ë¶„
                        if (key.includes("ì‹ì‚¬ ì¥ì†Œ")) {
                            mealSection.ì‹ì‚¬ì¥ì†Œ.ì¥ì†Œ = value;
                            currentSection = "ì‹ì‚¬ì¥ì†Œ";
                        } else if (key === "ëª…ì†Œ") {
                            mealSection.ëª…ì†Œ.ëª…ì†Œì´ë¦„ = value;
                            currentSection = "ëª…ì†Œ";
                        } else if (currentSection) {
                            if (currentSection === "ì‹ì‚¬ì¥ì†Œ") {
                                if (key === "ì£¼ì†Œ") mealSection.ì‹ì‚¬ì¥ì†Œ.ì£¼ì†Œ = value;
                                if (key === "ì˜ì—… ì‹œê°„") mealSection.ì‹ì‚¬ì¥ì†Œ.ì˜ì—…ì‹œê°„ = value;
                                if (key === "ìŒì‹ì  íŠ¹ì§•") mealSection.ì‹ì‚¬ì¥ì†Œ.ìŒì‹ì íŠ¹ì§• = value;
                                if (key === "ê¸°íƒ€ ì •ë³´") mealSection.ì‹ì‚¬ì¥ì†Œ.ê¸°íƒ€ì •ë³´ = value;
                            } else if (currentSection === "ëª…ì†Œ") {
                                if (key === "ì˜ì—… ì‹œê°„") mealSection.ëª…ì†Œ.ì˜ì—…ì‹œê°„ = value;
                                if (key === "ëª…ì†Œ íŠ¹ì§•") mealSection.ëª…ì†Œ.ëª…ì†ŒíŠ¹ì§• = value;
                                if (key === "ëª…ì†Œ ìœ„ì¹˜") mealSection.ëª…ì†Œ.ëª…ì†Œìœ„ì¹˜ = value;
                                if (key === "ê¸°íƒ€ ì •ë³´") mealSection.ëª…ì†Œ.ê¸°íƒ€ì •ë³´ = value;
                            }
                        }
                    }
                }
            });

            return result;
        }

        function attachDeleteEvent(folderItem, parentList, plusButton) {
            const deleteIcon = folderItem.querySelector('.delete-icon');
            if (!deleteIcon) return;

            deleteIcon.addEventListener('click', function() {
                // (A) bookmark_id ê°€ì ¸ì˜¤ê¸°
                const bookmarkId = deleteIcon.getAttribute('data-id');
                if (!bookmarkId) {
                    console.warn("No data-id found for this item, cannot delete in DB.");
                    return;
                }

                // (B) ì„œë²„ì— DELETE ìš”ì²­(AJAX)
                fetch("/app/partials/favorites/delete/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()  // CSRF í† í°
                    },
                    body: JSON.stringify({
                        bookmark_id: bookmarkId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        // ì˜ˆ: 404, 500 ë“±ì´ë©´ throw
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // (C) ì„±ê³µí•˜ë©´ UIì—ì„œ ì œê±°
                        folderItem.remove();
                        // parentList.removeChild(folderItem);
                        updateFolderListUI(parentList, plusButton);
                        console.log("ë¶ë§ˆí¬ ì‚­ì œ ì„±ê³µ:", bookmarkId);
                    } else {
                        // (D) ì‹¤íŒ¨ ì²˜ë¦¬
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.error || "unknown error"));
                    }
                })
                .catch(err => {
                    console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            });
        }

        function updateFolderListUI(folderList, plusButton) {
            if (!folderList) return;

            const items = folderList.querySelectorAll('.folder-item');
            const count = items.length;

            // ë²„íŠ¼ ë¹„í™œì„±í™”: 10ê°œ ì´ìƒì´ë©´ disabled
            if (plusButton) {
                if (count >= 11) {
                    plusButton.style.pointerEvents = 'none';
                    plusButton.style.opacity = '0.4';
                    // ë˜ëŠ” plusButton.setAttribute('disabled', true);
                } else {
                    plusButton.style.pointerEvents = 'auto';
                    plusButton.style.opacity = '1';
                    // plusButton.removeAttribute('disabled');
                }
            }
        }

        function addFolderEventHandler(plusElementId, sectionSelector, placeholderText, isPlaceValue, imagePaths) {
            const plusElement = document.getElementById(plusElementId);
            if (plusElement) {
                plusElement.addEventListener('click', function () {
                    // ì´ë¯¸ ì…ë ¥ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ë¬´ì‹œ
                    if (isPlaceValue ? isPlaceInputOpen : isScheduleInputOpen) return;
                    if (isPlaceValue) isPlaceInputOpen = true;
                    else isScheduleInputOpen = true;

                    const folderList = document.querySelector(`${sectionSelector} .folder-list`);
                    if (!folderList) return;

                    // ìƒˆ ì…ë ¥ì°½ ì•„ì´í…œ
                    const inputItem = document.createElement("div");
                    inputItem.className = "folder-item";

                    const inputElem = document.createElement("input");
                    inputElem.type = "text";
                    inputElem.placeholder = placeholderText;
                    inputElem.style.width = "200px";

                    inputItem.appendChild(inputElem);

                    folderList.insertBefore(inputItem, plusElement);

                    updateFolderListUI(folderList, plusElement);

                    inputElem.focus();

                    // Enterë¡œ í™•ì •
                    inputElem.addEventListener("keydown", function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            const textValue = inputElem.value.trim();
                            const isLightTheme = document.body.getAttribute("data-theme") === "light";

                            if (isPlaceValue) isPlaceInputOpen = false;
                            else isScheduleInputOpen = false;

                            // ì…ë ¥ì´ ì—†ìœ¼ë©´ ì·¨ì†Œ
                            if (textValue === "") {
                                folderList.removeChild(inputItem);
                                updateFolderListUI(folderList, plusElement);
                                return;
                            }

                            // ì„œë²„ë¡œ AJAX í˜¸ì¶œ
                            fetch("/app/partials/favorites/add/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken()
                                },
                                body: JSON.stringify({
                                    title: textValue,
                                    is_place: isPlaceValue,
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then((data) => {
                                if (data.success) {
                                    // ìƒì„± ì„±ê³µ ì‹œ, ìƒˆ ì•„ì´í…œ ìƒì„±
                                    const newItem = document.createElement("div");
                                    newItem.className = "folder-item";
                                    newItem.id = data.folderId; // ì„œë²„ì—ì„œ ë°˜í™˜ëœ folderIdë¥¼ idë¡œ ì„¤ì •
                                    newItem.innerHTML = `
                                        <img src="${isLightTheme ? imagePaths.light : imagePaths.dark}"
                                            alt="icon" width="50px" height="50px">
                                        &nbsp;&nbsp;&nbsp;&nbsp;${textValue}
                                        <img src="${isLightTheme ? "/static/images/delete_light.png" : "/static/images/delete_dark.png"}"
                                            alt="delete" width="50px" height="50px" class="delete-icon" data-id="${data.folderId}">
                                    `;
                                    folderList.replaceChild(newItem, inputItem);

                                    newItem.addEventListener('click', (event) => {
                                        if (event.target.classList.contains("delete-icon")) {
                                            return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ folder-itemì˜ ì´ë²¤íŠ¸ ì‹¤í–‰ ì°¨ë‹¨
                                        }
                                        
                                        // ìƒˆ í´ë” ë²„íŠ¼ì€ í•´ë‹¹ ì•ˆí•˜ë‹ˆê¹Œ íŒ¨ìŠ¤
                                        const backBtn = document.getElementById('backBtn');
                                        const backbookmarkTitleBtn = document.getElementById('bookmark_title');
                                        const placeBtn = document.getElementById('placeBtn');
                                        const scheduleBtn = document.getElementById('scheduleBtn');
                                        const topmenu = document.querySelector('.top-menu');
                                        const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                                        const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                                        const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                                        
                                        if (AllFolderLists) {
                                            AllFolderLists.forEach(folderList => {
                                                folderList.style.display = "none";
                                            });
                                        }
                                        
                                        topmenu.style.justifyContent = "start";
                                        backBtn.style.display = "block";
                                        backbookmarkTitleBtn.style.display = "block";
                                        backbookmarkTitleBtn.textContent = newItem.textContent.trim().replace(/\s{2,}/g, '').replace(/\u00a0+/g, '');
                                        placeBtn.style.display = "none";
                                        scheduleBtn.style.display = "none";

                                        // bookmark-place-itemê³¼ bookmark-schedule-item ì´ˆê¸°í™”
                                        if (bookmarkPlaceItemDiv) {                            
                                            bookmarkPlaceItemDiv.style.display = "none";
                                            bookmarkPlaceItemDiv.innerHTML = ""; // ê¸°ì¡´ ìì‹ ìš”ì†Œ ì œê±°
                                        }
                                        if (bookmarkScheduleItemDiv) {
                                            bookmarkScheduleItemDiv.style.display = "none";
                                            bookmarkScheduleItemDiv.innerHTML = ""; // ê¸°ì¡´ ìì‹ ìš”ì†Œ ì œê±°
                                        }
                                        
                                        // const bookmarkId = this.id; // í´ë¦­ëœ divì˜ ID ê°€ì ¸ì˜¤ê¸°
                                        // if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //     return; // "ìƒˆ í´ë”" ë²„íŠ¼ í´ë¦­ ì‹œ ë¬´ì‹œ
                                        // }

                                        // try {
                                        //     // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                        //     const response = await fetch(`/app/partials/favorites/get_bookmark_items/${bookmarkId}/`, {
                                        //         method: "GET",
                                        //         headers: {
                                        //             "Content-Type": "application/json",
                                        //         },
                                        //     });

                                        //     if (!response.ok) {
                                        //         throw new Error(`HTTP error! status: ${response.status}`);
                                        //     }

                                        //     const data = await response.json();
                                        //     if (data.type === "place") {
                                        //         // ì¥ì†Œ ì¦ê²¨ì°¾ê¸°
                                        //         if (bookmarkPlaceItemDiv) {
                                        //             bookmarkPlaceItemDiv.style.display = "block";

                                        //             data.rows.forEach(row => {
                                        //                 const itemDiv = document.createElement("div");
                                        //                 itemDiv.className = "place-item";
                                        //                 itemDiv.id = row.id;
                                        //                 itemDiv.innerHTML = `
                                        //                     <p style="display: flex; align-items: center;"><strong>ì´ë¦„:</strong> ${row.name}</p>
                                        //                 `;
                                        //                 itemDiv.addEventListener("click", async () => {
                                        //                     //DBì—ì„œ í•´ë‹¹ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                                        //                     document.querySelectorAll(".place-item").forEach(folder => {                                                
                                        //                         folder.style.backgroundColor = ""; // ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µì› (CSS ì´ˆê¸°ê°’)
                                        //                     });
                                        //                     document.getElementById("getBookmarkListBtn").textContent = "â˜…";
                                        //                     itemDiv.style.backgroundColor = "#999";

                                        //                     const bookmarkId = this.id; // folder-itemì˜ ID ê°’
                                        //                     if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //                         return; // "ìƒˆ í´ë”" ë²„íŠ¼ì€ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                                        //                     }

                                        //                     try {
                                        //                         // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                        //                         const response = await fetch(`/app/partials/favorites/bookmark-place-detail/${row.id}/`, {
                                        //                             method: "GET",
                                        //                             headers: {
                                        //                                 "Content-Type": "application/json",
                                        //                             },
                                        //                         });

                                        //                         if (!response.ok) {
                                        //                             throw new Error(`HTTP error! status: ${response.status}`);
                                        //                         }
                                                                
                                        //                         // UI ì—…ë°ì´íŠ¸: map-panel-content ë˜ëŠ” ë‹¤ë¥¸ ìš”ì†Œì— ë°ì´í„° í‘œì‹œ
                                        //                         const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±
                                        //                         const mapPanelContent = document.querySelector(".map-panel-content");
                                        //                         if (!mapPanelContent) {
                                        //                             console.error("map-panel-content element not found");
                                        //                             return;
                                        //                         }

                                        //                         // ê¸°ì¡´ ë‚´ìš© ì œê±°
                                        //                         mapPanelContent.innerHTML = "";

                                        //                         // ì¥ì†Œ ì •ë³´ í‘œì‹œ
                                        //                         if (data) {
                                        //                             const panelTitle = document.getElementById("panel-title");
                                        //                             panelTitle.innerHTML = `${row.name}`;
                                        //                             const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        //                             getBookmarkListBtn.classList.remove("schedule");
                                        //                             getBookmarkListBtn.classList.add("place");
                                        //                             getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                        //                             const placeSection = document.createElement("div");
                                        //                             placeSection.className = "place-section";
                                        //                             placeSection.innerHTML = `
                                        //                                 <h3>ì¥ì†Œ ì •ë³´</h3>
                                        //                                 <p><strong>ì´ë¦„:</strong> ${data.name}</p>
                                        //                                 <p><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
                                        //                                 <p><strong>ì„¤ëª…:</strong> ${data.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."}</p>
                                        //                             `;
                                        //                             mapPanelContent.appendChild(placeSection);
                                        //                         } else {
                                        //                             const noDataMessage = document.createElement("p");
                                        //                             noDataMessage.textContent = "í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                                        //                             mapPanelContent.appendChild(noDataMessage);
                                        //                         }
                                        //                     } catch (error) {
                                        //                         console.error("Error fetching bookmark place data:", error);
                                        //                     }
                                        //                 });

                                        //                 // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                                        //                 const deleteButton = document.createElement('img');
                                        //                 deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                        //                     ? '/static/images/delete_light.png' 
                                        //                     : '/static/images/delete_dark.png';
                                        //                 deleteButton.style.cursor = 'pointer';
                                        //                 deleteButton.style.marginLeft = 'auto';
                                        //                 deleteButton.style.marginRight = '10px';
                                        //                 deleteButton.style.opacity = '0.7';
                                        //                 deleteButton.width = 25;
                                        //                 deleteButton.height = 25;

                                        //                 // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                                        //                 deleteButton.addEventListener('click', (event) => {
                                        //                     event.stopPropagation();
                                        //                     // UIì—ì„œ ì œê±°
                                        //                     bookmarkPlaceItemDiv.removeChild(itemDiv);

                                        //                     //DBì—ì„œë„ í•´ë‹¹ ë°ì´í„° ì œê±°

                                        //                 });

                                        //                 deleteButton.addEventListener('mouseover', () => {
                                        //                     deleteButton.style.opacity = '1.0';
                                        //                 });

                                        //                 deleteButton.addEventListener('mouseleave', () => {
                                        //                     deleteButton.style.opacity = '0.7';
                                        //                 });

                                        //                 itemDiv.appendChild(deleteButton);
                                        //                 bookmarkPlaceItemDiv.appendChild(itemDiv);
                                        //             });
                                        //         }
                                        //     } 
                                        //     else if (data.type === "schedule") {
                                        //         // ì¼ì • ì¦ê²¨ì°¾ê¸°
                                        //         if (bookmarkScheduleItemDiv) {
                                        //             bookmarkScheduleItemDiv.style.display = "block";

                                        //             data.rows.forEach(row => {
                                        //                 const itemDiv = document.createElement("div");
                                        //                 itemDiv.className = "schedule-item";
                                        //                 itemDiv.id = row.id;
                                        //                 itemDiv.innerHTML = `
                                        //                     <p style="display: flex; align-items: center;"><strong>ì´ë¦„:</strong> ${row.name}</p>
                                        //                 `;
                                        //                 itemDiv.addEventListener("click", async () => {
                                        //                     document.querySelectorAll(".schedule-item").forEach(folder => {                                                
                                        //                         folder.style.backgroundColor = ""; // ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µì› (CSS ì´ˆê¸°ê°’)
                                        //                     });

                                        //                     document.getElementById("getBookmarkListBtn").textContent = "â˜…";
                                        //                     itemDiv.style.backgroundColor = "#999";

                                        //                     const bookmarkId = this.id; // folder-itemì˜ ID ê°’
                                        //                     if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //                         return; // "ìƒˆ í´ë”" ë²„íŠ¼ì€ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                                        //                     }

                                        //                     try {
                                        //                         // ì„œë²„ì— bookmark_idë¡œ ë°ì´í„° ìš”ì²­
                                        //                         const response = await fetch(`/app/partials/favorites/bookmark-schedule-detail/${row.id}/`, {
                                        //                             method: "GET",
                                        //                             headers: {
                                        //                                 "Content-Type": "application/json",
                                        //                             },
                                        //                         });

                                        //                         if (!response.ok) {
                                        //                             throw new Error(`HTTP error! status: ${response.status}`);
                                        //                         }

                                        //                         // UI ì—…ë°ì´íŠ¸: map-panel-content ë˜ëŠ” ë‹¤ë¥¸ ìš”ì†Œì— ë°ì´í„° í‘œì‹œ
                                        //                         const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±
                                        //                         const mapPanelContent = document.querySelector(".map-panel-content");
                                        //                         if (!mapPanelContent) {
                                        //                             console.error("map-panel-content element not found");
                                        //                             return;
                                        //                         }

                                        //                         // ê¸°ì¡´ ë‚´ìš© ì œê±°
                                        //                         mapPanelContent.innerHTML = "";

                                        //                         // ì¼ì • ì •ë³´ í‘œì‹œ
                                        //                         if (data) {;
                                        //                             const panelTitle = document.getElementById("panel-title");
                                        //                             panelTitle.innerHTML = `${row.name}`;
                                        //                             const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        //                             getBookmarkListBtn.classList.remove("place");
                                        //                             getBookmarkListBtn.classList.add("schedule");
                                        //                             getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                        //                             const jsonData = JSON.parse(data.json_data);
                                        //                             generateDayButtons(jsonData);
                                        //                             generateDynamicPlanContent(jsonData);
                                        //                         } else {
                                        //                             const noDataMessage = document.createElement("p");
                                        //                             noDataMessage.textContent = "í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                                        //                             mapPanelContent.appendChild(noDataMessage);
                                        //                         }
                                        //                     } catch (error) {
                                        //                         console.error("Error fetching bookmark place data:", error);
                                        //                     }
                                        //                 });

                                        //                 // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                                        //                 const deleteButton = document.createElement('img');
                                        //                 deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                        //                     ? '/static/images/delete_light.png' 
                                        //                     : '/static/images/delete_dark.png';
                                        //                 deleteButton.style.cursor = 'pointer';
                                        //                 deleteButton.style.marginLeft = 'auto';
                                        //                 deleteButton.style.marginRight = '10px';
                                        //                 deleteButton.style.opacity = '0.7';
                                        //                 deleteButton.width = 25;
                                        //                 deleteButton.height = 25;

                                        //                 // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                                        //                 deleteButton.addEventListener('click', (event) => {
                                        //                     event.stopPropagation();
                                        //                     // UIì—ì„œ ì œê±°  
                                        //                     itemDiv.remove();

                                        //                     //DBì—ì„œë„ í•´ë‹¹ ë°ì´í„° ì œê±°

                                        //                 });

                                        //                 deleteButton.addEventListener('mouseover', () => {
                                        //                     deleteButton.style.opacity = '1.0';
                                        //                 });

                                        //                 deleteButton.addEventListener('mouseleave', () => {
                                        //                     deleteButton.style.opacity = '0.7';
                                        //                 });

                                        //                 itemDiv.appendChild(deleteButton);
                                        //                 bookmarkScheduleItemDiv.appendChild(itemDiv);
                                        //             });
                                        //         }
                                        //     }
                                        //     else {
                                        //         console.log("No data found");
                                        //     }
                                        // } catch (error) {
                                        //     console.error("Error fetching bookmark data:", error);
                                        // }
                                    })
                                    attachDeleteEvent(newItem); // ì‚­ì œ ì´ë²¤íŠ¸ ì—°ê²°
                                    updateFolderListUI(folderList, plusElement);

                                    console.log("ìƒì„± ì„±ê³µ:", data.folderId);
                                } else {
                                    alert("ìƒì„± ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                                    folderList.removeChild(inputItem);
                                }
                            })
                            .catch((err) => {
                                console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                                folderList.removeChild(inputItem);
                            });
                        }
                    });
                });
            }
        }

        // ë„¤ì´ë²„ Geocoding APIë¥¼ í†µí•´ ê²½ë„ì™€ ìœ„ë„ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function getCoordinates(addresses) {
            if (!Array.isArray(addresses)) {
                console.error("Addresses must be an array.");
                return [];
            }
            const markerData = [];
            const promises = addresses.map(async ({ address, title }) => {
                if (!address) return; // addressê°€ ì—†ëŠ” ê²½ìš° ê±´ë„ˆëœ€

                const coordinates = await fetchCoordinates(address);
                if (coordinates) {
                    const [lat, lng] = coordinates;
                    markerData.push({
                        position: new naver.maps.LatLng(lat, lng),
                        title: title,
                        icon: `https://chart.googleapis.com/chart?chst=d_map_pin_number&chld=${markerData.length + 1}|FF0000|000000`,
                    });
                }
            });

            await Promise.all(promises); // ëª¨ë“  ë¹„ë™ê¸° ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            return markerData;
        }

        async function generateDynamicPlanContent(jsonData) {
            const mapPanelContent = document.querySelector('.map-panel-content');
            //í„°ë¯¸ë„ì— ì¶”ê°€ëœ ë‚´ìš©ì´ ìŠ¤ì¼€ì¤„ì´ë¼ëŠ” ê²ƒì„ ì²´í¬í•˜ê¸° ìœ„í•¨
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            getBookmarkListBtn.classList.remove("place");
            getBookmarkListBtn.classList.add("schedule");
            if (!mapPanelContent) {
                console.error('map-panel-content ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë§ˆì»¤ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´
            let markerData = [];

            async function renderDayContent(day) {
                // JSON ë°ì´í„°ì—ì„œ ì£¼ì†Œ ì •ë³´ ì¶”ì¶œ
                const addresses = [];
                Object.keys(day.meals).forEach(mealType => {
                    const mealData = day.meals[mealType];
                    if (mealData.ì‹ì‚¬ì¥ì†Œ && mealData.ì‹ì‚¬ì¥ì†Œ.ì£¼ì†Œ) {
                        addresses.push({
                            address: mealData.ì‹ì‚¬ì¥ì†Œ.ì£¼ì†Œ,
                            title: mealData.ì‹ì‚¬ì¥ì†Œ.ì¥ì†Œ || `${mealType} ì‹ì‚¬ì¥ì†Œ`
                        });
                    }
                    if (mealData.ëª…ì†Œ && mealData.ëª…ì†Œ.ëª…ì†Œìœ„ì¹˜) {
                        addresses.push({
                            address: mealData.ëª…ì†Œ.ëª…ì†Œìœ„ì¹˜,
                            title: mealData.ëª…ì†Œ.ëª…ì†Œì´ë¦„ || `${mealType} ëª…ì†Œ`
                        });
                    }
                });

                // ì§€ë„ ë‚´ìš© ì´ˆê¸°í™”
                mapPanelContent.innerHTML = '';
                const planContent = document.createElement('div');
                planContent.className = 'plan-content';
                mapPanelContent.appendChild(planContent);

                Object.keys(day.meals).forEach(mealType => {
                    const mealData = day.meals[mealType];
                    const mealSection = document.createElement('div');
                    mealSection.className = 'meal-section';
                    mealSection.innerHTML = `<h4>${mealType}</h4>`;

                    Object.keys(mealData).forEach(section => {
                        const sectionData = mealData[section];
                        if (sectionData) {
                            const name = sectionData["ì¥ì†Œ"] || sectionData["ëª…ì†Œì´ë¦„"];
                            const address = sectionData["ì£¼ì†Œ"] || sectionData["ëª…ì†Œìœ„ì¹˜"];
                            const overview = sectionData["ìŒì‹ì íŠ¹ì§•"] || sectionData["ëª…ì†ŒíŠ¹ì§•"];

                            if (name && address) {
                                const listItem = document.createElement('p');
                                listItem.innerHTML = `<strong>${name}</strong> (${address})`;

                                const buttonContainer = document.createElement('div');
                                buttonContainer.className = "button-container";
                                buttonContainer.setAttribute('overview', overview);
                                buttonContainer.setAttribute('address', address);
                                buttonContainer.style.display = 'inline-flex';
                                buttonContainer.style.alignItems = 'center';
                                buttonContainer.style.flexWrap = "nowrap";

                                // ì¦ê²¨ì°¾ê¸° ë“±ë¡ ë²„íŠ¼ ì¶”ê°€
                                const bookmarkButton = document.createElement('button');
                                bookmarkButton.style.cursor = 'pointer';
                                bookmarkButton.style.marginLeft = '5px';
                                bookmarkButton.style.border = "none";
                                bookmarkButton.textContent = "â˜†";
                                bookmarkButton.style.justifyContent = "center";
                                bookmarkButton.addEventListener('click', () => {
                                    getBookmarkList("true", `${name}`, `${address}`);
                                });

                                // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                                const deleteButton = document.createElement('img');
                                deleteButton.id = "deletePlaceBtn";
                                deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                    ? '/static/images/delete_light.png' 
                                    : '/static/images/delete_dark.png';
                                deleteButton.style.cursor = 'pointer';
                                deleteButton.width = 16;
                                deleteButton.height = 16;
                                deleteButton.style.display = "inline-flex"; // Flexboxì— ì í•©
                                deleteButton.style.alignItems = "center";
                                deleteButton.style.justifyContent = "center";

                                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                                deleteButton.addEventListener('click', () => {
                                    // UIì—ì„œ ì œê±°
                                    mealSection.removeChild(listItem);

                                    // JSON ë°ì´í„°ì—ì„œ í•´ë‹¹ í•­ëª© ì œê±°
                                    if (section === "ì‹ì‚¬ì¥ì†Œ") {
                                        delete mealData[section];
                                    } else if (section === "ëª…ì†Œ") {
                                        delete mealData[section];
                                    }

                                    // ì „ì—­ markerDataì—ì„œ í•´ë‹¹ ë§ˆì»¤ ì œê±°
                                    globalMarkerData = globalMarkerData.filter(marker => marker.title !== name);

                                    // ì§€ë„ ì—…ë°ì´íŠ¸
                                    addMarkersToMap(globalMarkerData);

                                    // ë””ë²„ê¹…ìš© ë¡œê·¸
                                    console.log("Updated globalMarkerData:", globalMarkerData);
                                    console.log("Updated JSON data:", day);
                                });

                                buttonContainer.appendChild(bookmarkButton);
                                buttonContainer.appendChild(deleteButton);
                                listItem.appendChild(buttonContainer);
                                mealSection.appendChild(listItem);
                            }
                        }
                    });

                    planContent.appendChild(mealSection);
                });

                // ì£¼ì†Œë¡œ ë§ˆì»¤ ë°ì´í„° ìƒì„±
                try {
                    globalMarkerData = await getCoordinates(addresses); // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    addMarkersToMap(globalMarkerData); // ì§€ë„ ì—…ë°ì´íŠ¸
                } catch (error) {
                    console.error("Error generating marker data:", error);
                }
            }


            // ë²„íŠ¼ ìƒì„± ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
            generateDayButtons(jsonData, (day) => {
                markerData = []; // ìƒˆë¡œìš´ ì¼ì°¨ ì„ íƒ ì‹œ ê¸°ì¡´ ë§ˆì»¤ ë°ì´í„° ì´ˆê¸°í™”
                console.log("Day object passed to renderDayContent:", day);
                renderDayContent(day); // ì„ íƒëœ ì¼ì°¨ì˜ ë°ì´í„° ë Œë”ë§
            });
        }

        function generateDayButtons(jsonData, renderDayContentCallback) {
            const mapPanel = document.getElementById('map-panel');
            if (!mapPanel) {
                console.error('map-panel ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let buttonContainer = document.getElementById('day-button-container');
            if (!buttonContainer) {
                buttonContainer = document.createElement('div');
                buttonContainer.id = 'day-button-container';
                buttonContainer.style.position = 'absolute';
                buttonContainer.style.top = `${mapPanel.getBoundingClientRect().top - 50}px`;
                buttonContainer.style.left = '40px';
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.zIndex = '100';

                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    mapContainer.appendChild(buttonContainer);
                } else {
                    console.error('map-container ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            } else {
                buttonContainer.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ì´ˆê¸°í™”
            }

            console.log("jsonData:", jsonData);
            console.log("1typeof jsonData:", typeof jsonData);
            if (typeof jsonData === "string") {
                jsonData = JSON.parse(jsonData);
                console.log("2typeof jsonData:", typeof jsonData);
            }
            console.log("3typeof jsonData:", typeof jsonData);
            
            let firstButton = null;
            jsonData.forEach((day, index) => {
                const dayButton = document.createElement('button');
                dayButton.textContent = `${day.day}ì¼ì°¨`;
                dayButton.style.padding = '8px 16px';
                dayButton.style.border = 'none';
                dayButton.style.borderRadius = '20px';
                dayButton.style.backgroundColor = '#ddd';
                dayButton.style.cursor = 'pointer';

                dayButton.addEventListener('click', () => {
                    const allButtons = buttonContainer.querySelectorAll('button');
                    allButtons.forEach(btn => (btn.style.backgroundColor = '#ddd'));
                    dayButton.style.backgroundColor = 'white';

                    if (typeof renderDayContentCallback === 'function') {
                        renderDayContentCallback(day);
                    }
                });

                if (index === 0) {
                    firstButton = dayButton;
                }

                buttonContainer.appendChild(dayButton);
            });

            if (firstButton) {
                firstButton.click();
            } else {
                console.error('ìƒì„±ëœ ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function addMarkersToMap(markerData) {
            console.log("markerData:", markerData);
            if (!map || !isMapInitialized) {
                console.error("Map is not initialized yet!");
                return;
            }
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (window.currentMarkers) {
                window.currentMarkers.forEach(marker => marker.setMap(null));
            }
            window.currentMarkers = []; // ìƒˆë¡œìš´ ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

            // ê¸°ì¡´ ì„  ì œê±°
            if (window.currentPolylines) {
                window.currentPolylines.forEach(polyline => polyline.setMap(null));
            }
            window.currentPolylines = []; // ìƒˆë¡œìš´ ì„  ë°°ì—´ ì´ˆê¸°í™”

            // ìƒˆ ë§ˆì»¤ ì¶”ê°€
            markerData.forEach(data => {
                const marker = new naver.maps.Marker({
                    position: data.position,
                    map: map,
                    title: data.title,
                    icon: {
                        url: data.icon,
                        size: new naver.maps.Size(36, 36), // ë§ˆì»¤ í¬ê¸°
                        origin: new naver.maps.Point(0, 0),
                        anchor: new naver.maps.Point(18, 36), // ë§ˆì»¤ ìœ„ì¹˜ ì¡°ì •
                    },
                });

                // ì •ë³´ì°½ ìƒì„±
                // var infoWindow = new naver.maps.InfoWindow({
                //     content: `<div style="width:100px;text-align:center;padding:10px;">
                //                 <h4>ê°€ë§¹ì  ì •ë³´</h4>
                //                 <p>ì—¬ê¸°ì— ê°€ë§¹ì  ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
                //             </div>`
                // });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒ ì‚¬í•­)
                naver.maps.Event.addListener(marker, 'click', function () {
                    alert(`${data.title}ì…ë‹ˆë‹¤!`);
                    //infoWindow.open(map, marker); // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ ì—´ê¸°
                });

                // í˜„ì¬ ë§ˆì»¤ë¥¼ ì „ì—­ ë°°ì—´ì— ì €ì¥
                window.currentMarkers.push(marker);
            });

            // ìƒˆ ì„  ì¶”ê°€
            if (markerData.length > 1) {
                for (let i = 0; i < markerData.length - 1; i++) {
                    const polyline = new naver.maps.Polyline({
                        map: map,
                        path: [markerData[i].position, markerData[i + 1].position], // ì¸ì ‘í•œ ë§ˆì»¤ ì—°ê²°
                        strokeColor: '#000000', // ì„  ìƒ‰ìƒ
                        strokeWeight: 0, // ì„  ë‘ê»˜
                        strokeStyle: 'solid', // ì„  ìŠ¤íƒ€ì¼ (solid, dashed, dotted ë“±)
                    });

                    // í˜„ì¬ ì„ ì„ ì „ì—­ ë°°ì—´ì— ì €ì¥
                    window.currentPolylines.push(polyline);
                }
            }

            // ì§€ë„ ë²”ìœ„ë¥¼ ì—…ë°ì´íŠ¸
            if (markerData.length > 0) {
                const bounds = new naver.maps.LatLngBounds();
                markerData.forEach(marker => bounds.extend(marker.position));
                map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
            }
        }

        async function fetchCoordinates(address) {
            // Proxy API ì—”ë“œí¬ì¸íŠ¸ URL ì„¤ì • (Django ë°±ì—”ë“œì˜ ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ)
            const url = `http://127.0.0.1:8000/proxy/geocode/?address=${encodeURIComponent(address)}`;

            try {
                const response = await fetch(url); // Fetch ìš”ì²­ ì „ì†¡
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±

                // ì¢Œí‘œ ë°ì´í„°ë¥¼ ë°˜í™˜
                if (data.addresses && data.addresses.length > 0) {
                    const { x: lng, y: lat } = data.addresses[0]; // x: ê²½ë„, y: ìœ„ë„
                    return [parseFloat(lat), parseFloat(lng)];
                } else {
                    console.error(`No valid coordinates found for address: ${address}`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching coordinates for ${address}:`, error);
                return null;
            }
        }

        async function getBookmarkList(is_place="", name=``, address=``) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const isSchedule = getBookmarkListBtn.classList.contains("schedule"); // ì¥ì†Œì¸ì§€ í™•ì¸
            const bookmarkID = getBookmarkListBtn.getAttribute("bookmark_id");
            let isPlace = getBookmarkListBtn.classList.contains("place"); // ì¥ì†Œì¸ì§€ í™•ì¸

            if (is_place) {
                isPlace = is_place;
            }

            if (isPlace || isSchedule) {               
                try {
                    const response = await fetch(`/app/partials/favorites/get_bookmark/?is_place=${isPlace}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {                        
                        let innerHtml = "";                        
                        const bookmarklistPanel = document.querySelector('.bookmarklist-panel ul');                        
                        const title = document.querySelector(".bookmarklist-panel h2");
                        const addressTitle = document.querySelector(".bookmarklist-panel h3");
                        const changeTitle = document.getElementById("change-title")
                        const panelTitle = document.querySelector("#panel-title");
                        bookmarklistPanel.innerHTML = "";

                        if (isPlace) {          
                            //ì¥ì†Œ ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ì œëª©ìœ¼ë¡œ ì§“ê¸°
                            if (address) {
                                addressTitle.textContent = address;
                            }
                            else if (document.querySelectorAll(".place-section p")[1]) {
                                addressTitle.textContent = document.querySelectorAll(".place-section p")[1].textContent.split(": ")[1];
                            }
                            // else { // ì±„íŒ… ë‚´ì—­ì—ì„œ ì¥ì†Œë¥¼ ì¦ê²¨ì°¾ê¸° ë“±ë¡í•˜ëŠ” ì¼€ì´ìŠ¤
                            // }
                            if (name) {
                                title.textContent = name;
                            }
                            else if (document.querySelector("#panel-title").textContent.trim()) {
                                title.textContent = document.querySelector("#panel-title").textContent.trim();
                            }
                            // else { // ì±„íŒ… ë‚´ì—­ì—ì„œ ì¥ì†Œë¥¼ ì¦ê²¨ì°¾ê¸° ë“±ë¡í•˜ëŠ” ì¼€ì´ìŠ¤
                            // } 
                            title.addEventListener("dblclick", function () {
                                changeTitle.value = title.textContent;
                                changeTitle.style.display = "block"; // ì…ë ¥ì°½ í‘œì‹œ
                                title.style.display = "none"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
                                changeTitle.focus();
                            });

                            // 2) Enter: ì œëª© ì €ì¥, ESC: ì·¨ì†Œ
                            changeTitle.addEventListener("keydown", async function (e) {
                                if (event.key === "Enter") {
                                    const newTitle = changeTitle.value.trim();
                                    
                                    if (!newTitle) {
                                        alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                        return;
                                    }
                                    
                                    title.textContent = newTitle;
                                    title.style.display = "block"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ í‘œì‹œ
                                    changeTitle.style.display = "none"; // ì…ë ¥ì°½ ìˆ¨ê¹€
                                } 
                                else if (event.key === "Escape") {
                                    title.style.display = "block"; // ê¸°ì¡´ í…ìŠ¤íŠ¸ í‘œì‹œ
                                    changeTitle.style.display = "none";  // ì…ë ¥ì°½ ìˆ¨ê¹€
                                }                    
                            });
                        }
                        else if (isSchedule) {
                            //ì¼ì • ì´ë¦„ì€ (ì¼ì • + ì‹œê°„)ìœ¼ë¡œ ì§“ê¸°  (ì˜ˆ:ì¼ì •250120102730)
                            // title.textContent = "";
                            if (panelTitle.textContent == "") {
                                // í˜„ì¬ ì‹œê° í¬ë§·íŒ…
                                const now = new Date();
                                const year = String(now.getFullYear()).slice(2); // ì—°ë„ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                const month = String(now.getMonth() + 1).padStart(2, "0"); // ì›” (1~12)
                                const day = String(now.getDate()).padStart(2, "0"); // ì¼
                                const hours = String(now.getHours()).padStart(2, "0"); // ì‹œê°„ (0~23)
                                const minutes = String(now.getMinutes()).padStart(2, "0"); // ë¶„
                                const seconds = String(now.getSeconds()).padStart(2, "0"); // ì´ˆ
                                const milliseconds = now.getTime();
                                // const curDate = `${year}.${month}.${day} ${hours}:${minutes}:${seconds}`;
                                const curDate = `${milliseconds.toString(16)}`;
                                title.textContent = "ì¼ì • " + curDate;
                            }
                            else {
                                title.textContent = panelTitle.textContent;
                            }
                        } 

                        //ê¸°ì¡´ ì¦ê²¨ì°¾ê¸° í•­ëª© ë²„íŠ¼ë“¤ ì¶”ê°€
                        data.bookmarks.forEach(bookmark => {
                                const createLi = document.createElement('li');                            
                                const milliseconds = new Date(bookmark['created_at']).getTime();
                                const colorValue = milliseconds % 0xFFFFFF; 
                                const hexColor = `#${colorValue.toString(16).padStart(6, '0')}`;
                                createLi.className = "bookmark_item";
                                createLi.id = bookmark['id'];
                                createLi.style.cursor = "pointer";
                                innerHtml = `
                                    <div style="background-color: ${hexColor}">
                                        <span style="font-size: 17px; color: white;">â˜…</span>
                                    </div>
                                    <p>${bookmark['title']}</p>
                                    <button>
                                        ${bookmarkID === bookmark['id'] 
                                            ? '<span style="font-size: 17px; color: #5454ea;">âœ”</span>' 
                                            : '<span style="font-size: 27px; color: white;">+</span>'
                                        }
                                    </button>
                                `;                            
                                createLi.innerHTML = innerHtml;
                                
                                createLi.addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('div').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('span').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('button').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('p').addEventListener('click', (event)=> {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                bookmarklistPanel.appendChild(createLi);
                        });
                        
                        //ìƒˆ ì¦ê²¨ì°¾ê¸° í•­ëª© ë§Œë“œëŠ” ë²„íŠ¼ ì¶”ê°€                        
                        const createLi = document.createElement('li');
                        createLi.className = "bookmark_item";
                        createLi.id = "add_bookmark_list_btn";   
                        innerHtml = `
                            <div>
                                <span>+</span>
                            </div>
                            <p>ìƒˆ ì¦ê²¨ì°¾ê¸° í•­ëª©</p>
                        `;              

                        //10ê°œ ë¯¸ë§Œì´ë©´ í™œì„±í™”, ê·¸ ì´ìƒì´ë©´ ë¹„í™œì„±í™” 
                        if (bookmarklistPanel.childNodes.length < 10) {
                            createLi.addEventListener('click', () => {
                                if (document.querySelectorAll("#new-folder").length == 0) {
                                    const add_bookmark_list_btn = document.getElementById("add_bookmark_list_btn");
                                    const inputElem = document.createElement("input");
                                    inputElem.id = "new-folder";
                                    inputElem.type = "text";
                                    inputElem.placeholder = "ìƒˆ í´ë” ì´ë¦„ ì…ë ¥ (Enter)";
                                    inputElem.style.width = "200px";
                                    inputElem.style.marginBottom = "20px";

                                    const plusElement = document.querySelector(".bookmarklist-panel ul");
                                    plusElement.insertBefore(inputElem, add_bookmark_list_btn);

                                    inputElem.focus();

                                    // Enterë¡œ í™•ì •
                                    inputElem.addEventListener("keydown", function (e) {
                                        if (e.key === "Enter") {
                                            e.preventDefault();
                                            const textValue = inputElem.value.trim();
                                            const isLightTheme = document.body.getAttribute("data-theme") === "light";

                                            // ì…ë ¥ì´ ì—†ìœ¼ë©´ ì·¨ì†Œ
                                            if (textValue !== "") {
                                                const inputItem = document.querySelector(`.bookmarklist-panel .folder-item`);
                                                const items = document.querySelectorAll('.bookmarklist-panel ul li');                                                                             
                                                inputElem.remove();

                                                // ì„œë²„ë¡œ AJAX í˜¸ì¶œ
                                                fetch("/app/partials/favorites/add/", {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                        "X-CSRFToken": getCSRFToken()
                                                    },
                                                    body: JSON.stringify({
                                                        title: textValue,
                                                        is_place: isPlace,
                                                    })
                                                })
                                                .then(response => {
                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }
                                                    return response.json();
                                                })
                                                .then((data) => {
                                                    if (data.success) {
                                                        const createLi = document.createElement('li');                            
                                                        const milliseconds = Date.now();
                                                        const colorValue = milliseconds % 0xFFFFFF; 
                                                        const hexColor = `#${colorValue.toString(16).padStart(6, '0')}`;
                                                        createLi.className = "bookmark_item";
                                                        createLi.id = data['id'];
                                                        innerHtml = `
                                                            <div style="background-color: ${hexColor}">
                                                                <span style="font-size: 17px; color: white;">â˜…</span>
                                                            </div>
                                                            <p>${textValue}</p>
                                                            <button>
                                                                ${bookmarkID === data['folderId'] 
                                                                    ? '<span style="font-size: 17px; color: #5454ea;">âœ”</span>' 
                                                                    : '<span style="font-size: 27px; color: white;">+</span>'
                                                                }
                                                            </button>
                                                        `;                            
                                                        createLi.innerHTML = innerHtml;
                                                        console.log("whia:", document.querySelector('.bookmarklist-panel ul'));
                                                        document.querySelector('.bookmarklist-panel ul').insertBefore(createLi, add_bookmark_list_btn);
                                                    } else {
                                                        alert("ìƒì„± ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                                                    }
                                                })
                                                .catch((err) => {
                                                    console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                                                });
                                            }                                    
                                        }
                                    });
                                }

                                // addFolderEventHandler(
                                //     "plus-place",
                                //     "#placesSection",
                                //     "ìƒˆ í´ë” ì´ë¦„ ì…ë ¥ (Enter)",
                                //     true,
                                //     { light: "/static/images/folder_light.png", dark: "/static/images/folder_dark.png" }
                                // );
                            })
                            createLi.classList.remove("button_inactive");
                            createLi.classList.add("button_active");
                        }
                        else {
                            createLi.classList.remove("button_active");
                            createLi.classList.add("button_inactive");
                        }

                        createLi.innerHTML = innerHtml;
                        bookmarklistPanel.appendChild(createLi);
                        
                        toggleAnimation();                       
                    } 
                } catch (error) {
                    console.error("Error fetching bookmarks:", error);
                }
            }
            else {
                alert("ì¦ê²¨ì°¾ê¸°ì— ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        function addClickEvent() {
            
        }

        async function deleteBookmarklist(row) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            try {
                const payload = {
                    bookmark_id: row.bookmark_id, // bookmark_idëŠ” í•­ìƒ í¬í•¨
                };
                if (row.id.includes("pc")) {
                    payload.bookmarkplace_id = row.id;
                    if (row.id == getBookmarkListBtn.getAttribute("bookmarkplace_id")) {
                        removeContent();
                    }
                }
                if (row.id.includes("sc")) {
                    payload.bookmarkschedule_id = row.bookmarkschedule_id;
                    if (row.id == getBookmarkListBtn.getAttribute("bookmarkschedule_id")) {
                        removeContent();
                    }
                }
                const response = await fetch(`/app/partials/favorites/delete_bookmarklist/`, {
                    method: "POST", // POST ìš”ì²­
                    headers: {
                        "Content-Type": "application/json", // JSON ë°ì´í„° ì „ì†¡
                    },
                    body: JSON.stringify(payload), // payloadë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë³¸ë¬¸ì— ì¶”ê°€
                });
            } catch (error) {
                console.error("Error fetching bookmarks:", error);
            }
        }

        function addToBookmark(li, span, isPlace, name, address) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const panelTitle= document.getElementById("panel-title");
            const bookmarkId = li.id; 
            let body = null;
            let nameData = name || document.querySelector(".bookmarklist-panel h2").textContent;
            let addressData = address || document.querySelector(".bookmarklist-panel h3").textContent;

            if (isPlace) {
                // getBookmarkListBtn.classList.remove('place');
                body = JSON.stringify({
                    is_place: true,
                    name: nameData,
                    bookmark_id: bookmarkId,
                    bookmarkplace_id: getBookmarkListBtn.getAttribute("bookmarkplace_id"),
                    bookmarkschedule_id: null,
                    category: null,
                    longitude: null,
                    latitude: null,
                    address: addressData,
                    overview: getBookmarkListBtn.getAttribute("overview"),
                })
            }
            else {
                body = JSON.stringify({
                    is_place: false,
                    name: nameData,
                    bookmark_id: bookmarkId,
                    bookmarkplace_id: null,
                    bookmarkschedule_id: getBookmarkListBtn.getAttribute("bookmarkschedule_id"),
                    json_data: getBookmarkListBtn.getAttribute("json_data"),
                })
            }

            span.textContent = "âœ”";
            span.style.fontSize = "17px";
            span.style.color = "#5454ea";

            fetch("/app/partials/favorites/add_bookmarklist/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), // Django CSRF í† í° í•„ìš”
                },
                body: body,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Bookmark list added successfully!");
                } else {
                    console.error("Error:", data.error || data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }

        function removeContent() {
            const map_panel_content = document.querySelector(".map-panel-content");
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const panelTitle= document.getElementById("panel-title");
            getBookmarkListBtn.classList.remove('place');
            getBookmarkListBtn.classList.remove('schedule');
            getBookmarkListBtn.setAttribute("bookmark_id", null);
            getBookmarkListBtn.setAttribute("bookmarkplace_id", null);
            getBookmarkListBtn.setAttribute("bookmarkschedule_id", null);
            getBookmarkListBtn.setAttribute("json_data", null);
            getBookmarkListBtn.textContent = "â˜†";

            panelTitle.innerHTML = "";
            map_panel_content.innerHTML = "";

        }

        function toggleMapPanel() {
            const minHeight = 45; // í„°ë¯¸ë„ ìµœì†Œ ë†’ì´
            const maxHeight = window.innerHeight / 2; // í„°ë¯¸ë„ ìµœëŒ€ ë†’ì´
            const toggleUIBtn = document.getElementById("toggleUIBtn");
            const mapPanel = document.getElementById("map-panel");
            const buttonContainer = document.getElementById("day-button-container");

            // transition ì ìš©
            mapPanel.style.transition = "height 0.5s ease";

            // í„°ë¯¸ë„ ë†’ì´ ë° ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            if (toggleUIBtn.textContent === "â®") {
                // í„°ë¯¸ë„ í™•ì¥
                mapPanel.style.height = `${maxHeight}px`;
                toggleUIBtn.textContent = "â®Ÿ";
                console.log("UI restored");
            } else {
                // í„°ë¯¸ë„ ì¶•ì†Œ
                mapPanel.style.height = `${minHeight}px`;
                toggleUIBtn.textContent = "â®";
                console.log("UI hidden");
            }

            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            if (buttonContainer) {
                buttonContainer.style.transition = "top 0.5s ease"; // ë¶€ë“œëŸ½ê²Œ ì´ë™
                const mapPanelHeight = parseInt(mapPanel.style.height, 10);
                const mapPanelTop = window.innerHeight - mapPanelHeight; // mapPanelì˜ ìƒë‹¨ ìœ„ì¹˜ ê³„ì‚°
                buttonContainer.style.top = `${mapPanelTop - buttonContainer.offsetHeight - 15}px`; // í„°ë¯¸ë„ ìœ„ë¡œ 15px
            }

            // transition ì œê±° (500ms í›„)
            setTimeout(() => {
                mapPanel.style.transition = "none";
                if (buttonContainer) {
                    buttonContainer.style.transition = "none";
                }
            }, 500); // transition ì‹œê°„ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
        }


        function toggleAnimation() {
            const animatedDiv = document.getElementById('bookmarklist-div');
            if (animatedDiv.classList.contains('active')) {
                // í™œì„±í™” ìƒíƒœì´ë©´ ìˆ¨ê¹€
                animatedDiv.classList.remove('active');
            } else {
                // ë¹„í™œì„±í™” ìƒíƒœì´ë©´ ë‚˜íƒ€ëƒ„
                animatedDiv.classList.add('active');
            }
        }
    </script>
</body>
</html>
